<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MusicPlatforme ‚Äî –°–ª—É—à–∞–π –º—É–∑—ã–∫—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ</title>
<meta name="description" content="MusicPlatforme ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞. –°–ª—É—à–∞–π, –ø—É–±–ª–∏–∫—É–π –∏ –æ—Ç–∫—Ä—ã–≤–∞–π –Ω–æ–≤—É—é –º—É–∑—ã–∫—É. –ú–æ—è –≤–æ–ª–Ω–∞, –ø–æ–¥–ø–∏—Å–∫–∏, –ª–∞–π–∫–∏ –∏ —É–º–Ω–∞—è –ò–ò-–º–æ–¥–µ—Ä–∞—Ü–∏—è.">
<meta name="keywords" content="MusicPlatforme, –º—É–∑—ã–∫–∞, —Å–ª—É—à–∞—Ç—å –º—É–∑—ã–∫—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞, –º–æ—è –≤–æ–ª–Ω–∞, –ø—É–±–ª–∏–∫–∞—Ü–∏—è –º—É–∑—ã–∫–∏">
<meta name="author" content="MusicPlatforme">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://vriskasYT.github.io/musicplatforme">
<meta property="og:title" content="MusicPlatforme ‚Äî –°–ª—É—à–∞–π –º—É–∑—ã–∫—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ">
<meta property="og:description" content="–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å —É–º–Ω–æ–π –ò–ò-–º–æ–¥–µ—Ä–∞—Ü–∏–µ–π. –°–ª—É—à–∞–π, –ø—É–±–ª–∏–∫—É–π –∏ –æ—Ç–∫—Ä—ã–≤–∞–π –Ω–æ–≤—É—é –º—É–∑—ã–∫—É.">
<meta property="og:url" content="https://vriskasYT.github.io/musicplatforme">
<meta property="og:type" content="website">
<meta property="og:site_name" content="MusicPlatforme">
<meta property="og:locale" content="ru_RU">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="MusicPlatforme ‚Äî –°–ª—É—à–∞–π –º—É–∑—ã–∫—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ">
<meta name="twitter:description" content="–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å —É–º–Ω–æ–π –ò–ò-–º–æ–¥–µ—Ä–∞—Ü–∏–µ–π.">
<meta name="theme-color" content="#6750A4">
<meta name="msapplication-TileColor" content="#6750A4">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%236750A4'/%3E%3Cstop offset='100%25' stop-color='%23D0BCFF'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='50' fill='url(%23g)'/%3E%3Ctext x='50' y='68' font-size='55' text-anchor='middle' fill='white' font-family='Arial'%3E‚ô™%3C/text%3E%3C/svg%3E">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebApplication","name":"MusicPlatforme","url":"https://vriskasYT.github.io/musicplatforme","description":"–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å —É–º–Ω–æ–π –ò–ò-–º–æ–¥–µ—Ä–∞—Ü–∏–µ–π.","applicationCategory":"MusicApplication","operatingSystem":"Web","offers":{"@type":"Offer","price":"0","priceCurrency":"RUB"}}
</script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">
<style>
:root{--md-primary:#6750A4;--md-on-primary:#FFF;--md-primary-container:#EADDFF;--md-on-primary-container:#21005D;--md-secondary:#625B71;--md-on-secondary:#FFF;--md-secondary-container:#E8DEF8;--md-tertiary:#7D5260;--md-tertiary-container:#FFD8E4;--md-surface:#FEF7FF;--md-surface-dim:#DED8E1;--md-surface-bright:#FEF7FF;--md-surface-container-lowest:#FFF;--md-surface-container-low:#F7F2FA;--md-surface-container:#F3EDF7;--md-surface-container-high:#ECE6F0;--md-surface-container-highest:#E6E0E9;--md-on-surface:#1D1B20;--md-on-surface-variant:#49454F;--md-outline:#79747E;--md-outline-variant:#CAC4D0;--md-error:#B3261E;--md-error-container:#F9DEDC;--md-on-error:#FFF;--md-inverse-surface:#322F35;--md-inverse-on-surface:#F5EFF7;--md-elevation-1:0 1px 3px 1px rgba(0,0,0,.15),0 1px 2px rgba(0,0,0,.3);--md-elevation-2:0 2px 6px 2px rgba(0,0,0,.15),0 1px 2px rgba(0,0,0,.3);--md-elevation-3:0 4px 8px 3px rgba(0,0,0,.15),0 1px 3px rgba(0,0,0,.3);--md-shape-sm:8px;--md-shape-md:12px;--md-shape-lg:16px;--md-shape-xl:28px;--md-shape-full:9999px;--player-height:72px;--nav-height:56px;--sidebar-width:280px}
[data-theme="dark"]{--md-primary:#D0BCFF;--md-on-primary:#381E72;--md-primary-container:#4F378B;--md-on-primary-container:#EADDFF;--md-secondary:#CCC2DC;--md-on-secondary:#332D41;--md-secondary-container:#4A4458;--md-tertiary:#EFB8C8;--md-tertiary-container:#633B48;--md-surface:#141218;--md-surface-dim:#141218;--md-surface-bright:#3B383E;--md-surface-container-lowest:#0F0D13;--md-surface-container-low:#1D1B20;--md-surface-container:#211F26;--md-surface-container-high:#2B2930;--md-surface-container-highest:#36343B;--md-on-surface:#E6E0E9;--md-on-surface-variant:#CAC4D0;--md-outline:#938F99;--md-outline-variant:#49454F;--md-error:#F2B8B5;--md-error-container:#8C1D18;--md-on-error:#601410;--md-inverse-surface:#E6E0E9;--md-inverse-on-surface:#322F35}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent!important;-webkit-touch-callout:none}
*:focus{outline:none!important}
*:focus-visible{outline:2px solid var(--md-primary);outline-offset:2px;border-radius:4px}
html{scroll-behavior:smooth}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--md-surface);color:var(--md-on-surface);overflow-x:hidden;transition:background .4s ease,color .4s ease;min-height:100vh;min-height:100dvh;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--md-outline-variant);border-radius:3px}
.material-symbols-rounded{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24;user-select:none;-webkit-user-select:none}
.material-symbols-rounded.filled{font-variation-settings:'FILL' 1,'wght' 400,'GRAD' 0,'opsz' 24}
button,a,[onclick],input,select,textarea{outline:none!important;-webkit-tap-highlight-color:transparent!important;-webkit-touch-callout:none}

/* ===== BUTTONS ===== */
.btn-primary{display:inline-flex;align-items:center;gap:8px;padding:10px 24px;background:var(--md-primary);color:var(--md-on-primary);border:none;border-radius:var(--md-shape-full);font:500 14px/20px 'Inter',sans-serif;letter-spacing:.1px;cursor:pointer;transition:all .25s cubic-bezier(.2,0,0,1);box-shadow:var(--md-elevation-1);user-select:none;position:relative;overflow:hidden}
.btn-primary::after{content:'';position:absolute;inset:0;background:currentColor;opacity:0;transition:opacity .2s}
.btn-primary:hover{box-shadow:var(--md-elevation-2);transform:translateY(-1px)}.btn-primary:hover::after{opacity:.08}
.btn-primary:active{transform:scale(.97);box-shadow:var(--md-elevation-1)}.btn-primary:active::after{opacity:.12}
.btn-primary:disabled{opacity:.5;pointer-events:none}

.btn-tonal{display:inline-flex;align-items:center;gap:8px;padding:10px 24px;background:var(--md-secondary-container);color:var(--md-on-surface);border:none;border-radius:var(--md-shape-full);font:500 14px/20px 'Inter',sans-serif;cursor:pointer;transition:all .25s cubic-bezier(.2,0,0,1);user-select:none;position:relative;overflow:hidden}
.btn-tonal::after{content:'';position:absolute;inset:0;background:currentColor;opacity:0;transition:opacity .2s}
.btn-tonal:hover{box-shadow:var(--md-elevation-1)}.btn-tonal:hover::after{opacity:.08}
.btn-tonal:active{transform:scale(.97)}.btn-tonal:active::after{opacity:.12}

.btn-outlined{display:inline-flex;align-items:center;gap:8px;padding:10px 24px;background:transparent;color:var(--md-primary);border:1px solid var(--md-outline);border-radius:var(--md-shape-full);font:500 14px/20px 'Inter',sans-serif;cursor:pointer;transition:all .25s cubic-bezier(.2,0,0,1);user-select:none}
.btn-outlined:hover{background:rgba(103,80,164,.08)}.btn-outlined:active{transform:scale(.97)}

.btn-text{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:transparent;color:var(--md-primary);border:none;border-radius:var(--md-shape-full);font:500 14px/20px 'Inter',sans-serif;cursor:pointer;transition:all .2s;user-select:none}
.btn-text:hover{background:rgba(103,80,164,.08)}

.btn-icon{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;background:transparent;color:var(--md-on-surface-variant);border:none;border-radius:var(--md-shape-full);cursor:pointer;transition:all .25s cubic-bezier(.2,0,0,1);position:relative;overflow:hidden;user-select:none;flex-shrink:0}
.btn-icon::after{content:'';position:absolute;inset:0;background:currentColor;opacity:0;transition:opacity .2s;border-radius:50%}
.btn-icon:hover::after{opacity:.08}.btn-icon:active::after{opacity:.12}
.btn-icon.active{color:var(--md-primary)}

/* ===== CHIPS ===== */
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 16px;border:1px solid var(--md-outline-variant);border-radius:var(--md-shape-sm);font:500 13px/18px 'Inter',sans-serif;color:var(--md-on-surface-variant);cursor:pointer;transition:all .25s cubic-bezier(.2,0,0,1);white-space:nowrap;user-select:none}
.chip:hover{background:var(--md-surface-container-high);transform:translateY(-1px)}
.chip.active{background:var(--md-secondary-container);color:var(--md-on-surface);border-color:transparent;box-shadow:var(--md-elevation-1)}

/* ===== INPUTS ===== */
.md-input{width:100%;padding:16px;background:var(--md-surface-container-highest);border:none;border-radius:var(--md-shape-xl);font:400 16px/24px 'Inter',sans-serif;color:var(--md-on-surface);outline:none;transition:all .3s cubic-bezier(.2,0,0,1)}
.md-input:focus{outline:2px solid var(--md-primary)!important;background:var(--md-surface-container-high)}.md-input::placeholder{color:var(--md-on-surface-variant)}

/* ===== CARDS ===== */
.md-card{background:var(--md-surface-container-low);border-radius:var(--md-shape-md);overflow:hidden;transition:all .3s cubic-bezier(.2,0,0,1);cursor:pointer;position:relative}
.md-card::after{content:'';position:absolute;inset:0;background:var(--md-primary);opacity:0;transition:opacity .3s;pointer-events:none}
.md-card:hover{box-shadow:var(--md-elevation-2);transform:translateY(-4px)}.md-card:hover::after{opacity:.04}
.md-card:active{transform:translateY(-1px)}
.md-card .card-img{width:100%;aspect-ratio:1;object-fit:cover;background:var(--md-surface-container-highest);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
.md-card .card-img img{width:100%;height:100%;object-fit:cover;transition:transform .4s cubic-bezier(.2,0,0,1)}
.md-card:hover .card-img img{transform:scale(1.05)}
.md-card .card-img .material-symbols-rounded{font-size:48px;color:var(--md-outline)}
.md-card .card-img .card-play-fab{position:absolute;right:8px;bottom:8px;width:40px;height:40px;border-radius:50%;background:var(--md-primary);color:var(--md-on-primary);display:flex;align-items:center;justify-content:center;box-shadow:var(--md-elevation-2);opacity:0;transform:translateY(8px);transition:all .3s cubic-bezier(.2,0,0,1)}
.md-card:hover .card-play-fab{opacity:1;transform:translateY(0)}
.md-card .card-body{padding:12px}
.md-card .card-title{font:500 14px/20px 'Inter',sans-serif;color:var(--md-on-surface);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.md-card .card-sub{font:400 12px/16px 'Inter',sans-serif;color:var(--md-on-surface-variant);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ===== EXPLICIT BADGE ===== */
.explicit-badge{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:var(--md-error);color:white;font-size:12px;font-weight:700;flex-shrink:0;line-height:1}

/* ===== SIDEBAR ===== */
.sidebar{width:var(--sidebar-width);background:var(--md-surface-container);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform .4s cubic-bezier(.2,0,0,1);overflow-y:auto}
.sidebar-header{padding:16px 20px;display:flex;align-items:center;gap:10px}
.sidebar-logo{width:36px;height:36px;border-radius:var(--md-shape-full);background:linear-gradient(135deg,var(--md-primary),var(--md-tertiary));display:flex;align-items:center;justify-content:center;color:white;font-size:20px;flex-shrink:0;transition:transform .3s;animation:logoFloat 4s ease-in-out infinite}
@keyframes logoFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
.sidebar-brand{font:700 18px/24px 'Inter',sans-serif;color:var(--md-on-surface)}
.sidebar nav{flex:1;padding:8px 12px}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:var(--md-shape-full);font:500 14px/20px 'Inter',sans-serif;color:var(--md-on-surface-variant);cursor:pointer;transition:all .25s cubic-bezier(.2,0,0,1);margin-bottom:2px;text-decoration:none;user-select:none;position:relative;overflow:hidden}
.nav-item::after{content:'';position:absolute;inset:0;background:currentColor;opacity:0;transition:opacity .2s;border-radius:var(--md-shape-full)}
.nav-item:hover::after{opacity:.06}
.nav-item.active{background:var(--md-secondary-container);color:var(--md-on-surface)}
.nav-item.active .material-symbols-rounded{font-variation-settings:'FILL' 1}
.nav-divider{height:1px;background:var(--md-outline-variant);margin:8px 16px}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:99;opacity:0;transition:opacity .3s}
.sidebar-overlay.open{display:block;opacity:1}

/* ===== MAIN ===== */
.main-content{flex:1;margin-left:var(--sidebar-width);padding-bottom:100px;transition:margin .3s}
.top-bar{position:sticky;top:0;z-index:50;display:flex;align-items:center;gap:12px;padding:8px 24px;background:var(--md-surface);backdrop-filter:blur(20px);transition:box-shadow .3s,background .3s}
.top-bar.scrolled{box-shadow:var(--md-elevation-2);background:color-mix(in srgb,var(--md-surface) 90%,transparent)}
.top-bar .menu-btn{display:none}
.search-bar{flex:1;max-width:720px;position:relative}
.search-bar .material-symbols-rounded{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--md-on-surface-variant);font-size:20px;transition:color .2s}
.search-bar input{width:100%;padding:10px 16px 10px 48px;background:var(--md-surface-container-highest);border:none;border-radius:var(--md-shape-full);font:400 14px/20px 'Inter',sans-serif;color:var(--md-on-surface);transition:all .3s cubic-bezier(.2,0,0,1)}
.search-bar input:focus{outline:2px solid var(--md-primary)!important;background:var(--md-surface-container-high)}
.search-bar input:focus~.material-symbols-rounded{color:var(--md-primary)}
.user-area{display:flex;align-items:center;gap:4px;margin-left:auto}
.user-avatar{width:36px;height:36px;border-radius:var(--md-shape-full);background:var(--md-primary-container);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;flex-shrink:0;transition:transform .2s,box-shadow .2s}
.user-avatar:hover{transform:scale(1.08);box-shadow:var(--md-elevation-1)}
.user-avatar img{width:100%;height:100%;object-fit:cover}.user-avatar .material-symbols-rounded{font-size:20px;color:var(--md-primary)}

/* ===== PAGES ===== */
.page{display:none;padding:16px 24px;animation:pageIn .4s cubic-bezier(.2,0,0,1)}.page.active{display:block}
@keyframes pageIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.section-title{font:700 22px/28px 'Inter',sans-serif;color:var(--md-on-surface);margin-bottom:16px}
.section-sub{font:400 14px/20px 'Inter',sans-serif;color:var(--md-on-surface-variant);margin-bottom:24px}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;margin-bottom:32px}

/* ===== TRACK LIST ===== */
.track-list{margin-bottom:32px}
.track-item{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:var(--md-shape-md);cursor:pointer;transition:all .25s cubic-bezier(.2,0,0,1);position:relative;overflow:hidden}
.track-item::after{content:'';position:absolute;inset:0;background:var(--md-primary);opacity:0;transition:opacity .2s;pointer-events:none}
.track-item:hover{background:var(--md-surface-container-high)}.track-item:hover::after{opacity:.02}
.track-item.playing{background:var(--md-primary-container)}.track-item.playing::after{opacity:.04}
.track-num{width:24px;text-align:center;font:400 14px/20px 'Inter',sans-serif;color:var(--md-on-surface-variant);flex-shrink:0}
.track-thumb{width:48px;height:48px;border-radius:var(--md-shape-sm);background:var(--md-surface-container-highest);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;position:relative;transition:transform .2s}
.track-item:hover .track-thumb{transform:scale(1.05)}
.track-thumb img{width:100%;height:100%;object-fit:cover}
.track-thumb .play-overlay{position:absolute;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .25s cubic-bezier(.2,0,0,1);backdrop-filter:blur(2px)}
.track-item:hover .play-overlay{opacity:1}
.track-info{flex:1;min-width:0}
.track-title-row{display:flex;align-items:center;gap:6px}
.track-name{font:500 14px/20px 'Inter',sans-serif;color:var(--md-on-surface);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;transition:color .2s}
.track-item:hover .track-name{color:var(--md-primary)}
.track-artist{font:400 12px/16px 'Inter',sans-serif;color:var(--md-on-surface-variant);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.track-artist:hover{color:var(--md-primary);text-decoration:underline}
.track-duration{font:400 12px/16px 'Inter',sans-serif;color:var(--md-on-surface-variant);flex-shrink:0}
.track-actions{display:flex;align-items:center;gap:2px;flex-shrink:0}
@media(hover:hover){.track-actions{opacity:0;transition:opacity .25s}.track-item:hover .track-actions{opacity:1}}
.track-plays{font:400 11px/16px 'Inter',sans-serif;color:var(--md-on-surface-variant);display:flex;align-items:center;gap:2px;flex-shrink:0;margin-right:8px}
.track-plays .material-symbols-rounded{font-size:14px}

/* ===== PLAYER BAR ===== */
.player-bar{position:fixed;left:0;right:0;bottom:0;height:var(--player-height);background:var(--md-surface-container-high);border-top:1px solid var(--md-outline-variant);display:none;align-items:center;padding:0 16px;z-index:210;gap:12px;backdrop-filter:blur(20px);transition:transform .4s cubic-bezier(.2,0,0,1)}
.player-bar.visible{display:flex;animation:slideUp .4s cubic-bezier(.2,0,0,1)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.player-track-info{display:flex;align-items:center;gap:12px;min-width:200px;max-width:300px;flex:1;cursor:pointer;transition:opacity .2s}
.player-track-info:hover{opacity:.85}
.player-thumb{width:48px;height:48px;border-radius:var(--md-shape-sm);background:var(--md-surface-container-highest);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;transition:border-radius .3s}
.player-thumb img{width:100%;height:100%;object-fit:cover}
.player-meta{min-width:0}
.player-title-row{display:flex;align-items:center;gap:6px}
.player-song{font:500 14px/20px 'Inter',sans-serif;color:var(--md-on-surface);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.player-artist-name{font:400 12px/16px 'Inter',sans-serif;color:var(--md-on-surface-variant);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer}
.player-artist-name:hover{color:var(--md-primary)}
.player-controls{display:flex;flex-direction:column;align-items:center;gap:2px;flex:2;max-width:600px}
.player-buttons{display:flex;align-items:center;gap:8px}
.player-play-btn{width:40px;height:40px;border-radius:var(--md-shape-full);background:var(--md-primary);color:var(--md-on-primary);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .25s cubic-bezier(.2,0,0,1)}
.player-play-btn:hover{transform:scale(1.1);box-shadow:var(--md-elevation-2)}
.player-play-btn:active{transform:scale(.95)}
.player-play-btn .material-symbols-rounded{transition:transform .2s cubic-bezier(.2,0,0,1)}
.progress-bar{display:flex;align-items:center;gap:8px;width:100%}
.progress-time{font:400 11px/16px 'Inter',sans-serif;color:var(--md-on-surface-variant);min-width:36px;text-align:center;font-variant-numeric:tabular-nums}
.progress-track{flex:1;height:4px;background:var(--md-outline-variant);border-radius:2px;cursor:pointer;position:relative;transition:height .2s}
.progress-track:hover{height:6px}
.progress-fill{height:100%;background:var(--md-primary);border-radius:2px;width:0%;transition:width .1s linear;position:relative}
.progress-fill::after{content:'';position:absolute;right:-6px;top:50%;transform:translateY(-50%) scale(0);width:12px;height:12px;background:var(--md-primary);border-radius:50%;transition:transform .2s cubic-bezier(.2,0,0,1);box-shadow:var(--md-elevation-1)}
.progress-track:hover .progress-fill::after{transform:translateY(-50%) scale(1)}
.progress-buffered{position:absolute;top:0;left:0;height:100%;background:var(--md-outline);opacity:.3;border-radius:2px;transition:width .3s}
.player-volume{display:flex;align-items:center;gap:4px;flex:1;max-width:200px;justify-content:flex-end}
.volume-slider{width:100px;height:4px;background:var(--md-outline-variant);border-radius:2px;cursor:pointer;position:relative;transition:height .2s}
.volume-slider:hover{height:6px}
.volume-fill{height:100%;width:80%;background:var(--md-primary);border-radius:2px;transition:width .15s}

/* ===== WAVE ===== */
.wave-container{text-align:center;padding:40px 20px}
.wave-circle{width:200px;height:200px;border-radius:50%;background:linear-gradient(135deg,var(--md-primary),var(--md-tertiary));margin:0 auto 24px;display:flex;align-items:center;justify-content:center;position:relative;animation:wavePulse 3s ease-in-out infinite;transition:all .3s}
.wave-circle.playing-anim{animation:wavePulse 1.5s ease-in-out infinite}
@keyframes wavePulse{0%,100%{box-shadow:0 0 0 0 rgba(103,80,164,.3)}50%{box-shadow:0 0 0 20px rgba(103,80,164,0)}}
.wave-circle .material-symbols-rounded{font-size:64px;color:white;transition:transform .3s}
.wave-circle:hover .material-symbols-rounded{transform:scale(1.1)}

/* ===== MODALS ===== */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;align-items:center;justify-content:center;padding:16px;opacity:0;transition:opacity .3s}
.modal-overlay.open{display:flex;animation:modalOverlayIn .3s forwards}
@keyframes modalOverlayIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--md-surface-container-high);border-radius:var(--md-shape-xl);width:100%;max-width:480px;max-height:90vh;overflow-y:auto;padding:24px;animation:modalIn .4s cubic-bezier(.2,0,0,1)}
@keyframes modalIn{from{opacity:0;transform:scale(.85) translateY(20px)}to{opacity:1;transform:none}}
.modal-title{font:700 22px/28px 'Inter',sans-serif;color:var(--md-on-surface);margin-bottom:16px}
.modal-label{font:500 12px/16px 'Inter',sans-serif;color:var(--md-on-surface-variant);margin-bottom:6px;display:block}
.modal .md-input{margin-bottom:16px;border-radius:var(--md-shape-md)}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}

/* ===== UPLOAD ===== */
.upload-zone{border:2px dashed var(--md-outline-variant);border-radius:var(--md-shape-lg);padding:32px;text-align:center;cursor:pointer;transition:all .3s cubic-bezier(.2,0,0,1);margin-bottom:16px;position:relative;overflow:hidden}
.upload-zone::after{content:'';position:absolute;inset:0;background:var(--md-primary);opacity:0;transition:opacity .3s}
.upload-zone:hover,.upload-zone.dragover{border-color:var(--md-primary);transform:scale(1.01)}.upload-zone:hover::after,.upload-zone.dragover::after{opacity:.03}
.upload-zone .material-symbols-rounded{font-size:48px;color:var(--md-primary);margin-bottom:8px;position:relative;z-index:1;transition:transform .3s}
.upload-zone:hover .material-symbols-rounded{transform:translateY(-4px)}

/* ===== PROFILE ===== */
.profile-header{display:flex;align-items:center;gap:24px;padding:32px 0}
.profile-avatar{width:120px;height:120px;border-radius:50%;background:var(--md-primary-container);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;position:relative;transition:transform .3s;box-shadow:var(--md-elevation-2)}
.profile-avatar:hover{transform:scale(1.05)}
.profile-avatar img{width:100%;height:100%;object-fit:cover}
.profile-avatar .material-symbols-rounded{font-size:48px;color:var(--md-primary)}
.profile-info{flex:1}
.profile-name{font:700 28px/36px 'Inter',sans-serif;color:var(--md-on-surface)}
.profile-stats{display:flex;gap:24px;margin-top:8px;font:400 14px/20px 'Inter',sans-serif;color:var(--md-on-surface-variant)}
.profile-stats strong{color:var(--md-on-surface);font-weight:600}
.profile-stats span{transition:color .2s;cursor:default}.profile-stats span:hover{color:var(--md-on-surface)}

/* ===== BOTTOM NAV ===== */
.bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;height:var(--nav-height);background:var(--md-surface-container);border-top:1px solid var(--md-outline-variant);z-index:200;align-items:center;justify-content:space-around}
.bottom-nav .nav-tab{display:flex;flex-direction:column;align-items:center;gap:2px;padding:4px 0;cursor:pointer;color:var(--md-on-surface-variant);transition:color .25s;border:none;background:none;font:500 11px/16px 'Inter',sans-serif;user-select:none}
.bottom-nav .nav-tab.active{color:var(--md-primary)}
.bottom-nav .nav-tab.active .material-symbols-rounded{font-variation-settings:'FILL' 1}
.nav-tab-indicator{width:64px;height:32px;border-radius:var(--md-shape-full);display:flex;align-items:center;justify-content:center;transition:background .25s cubic-bezier(.2,0,0,1)}
.nav-tab.active .nav-tab-indicator{background:var(--md-secondary-container)}

/* ===== SNACKBAR ===== */
.snackbar{position:fixed;left:50%;transform:translateX(-50%) translateY(100px);background:var(--md-inverse-surface);color:var(--md-inverse-on-surface);padding:14px 24px;border-radius:var(--md-shape-md);font:400 14px/20px 'Inter',sans-serif;box-shadow:var(--md-elevation-3);z-index:9999;transition:transform .4s cubic-bezier(.2,0,0,1),opacity .3s;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis;pointer-events:none;opacity:0;bottom:24px}
.snackbar.show{transform:translateX(-50%) translateY(0);opacity:1;pointer-events:auto}

/* ===== GENRE PILLS ===== */
.genre-pills{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;margin-bottom:24px;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
.genre-pills::-webkit-scrollbar{display:none}

/* ===== ARTIST ===== */
.artist-card{text-align:center;cursor:pointer;transition:transform .3s}
.artist-card:hover{transform:translateY(-4px)}
.artist-img{width:100%;aspect-ratio:1;border-radius:50%;background:var(--md-surface-container-highest);display:flex;align-items:center;justify-content:center;overflow:hidden;transition:all .3s cubic-bezier(.2,0,0,1);margin-bottom:8px;box-shadow:0 0 0 0 var(--md-primary)}
.artist-card:hover .artist-img{transform:scale(1.08);box-shadow:0 0 0 3px var(--md-primary)}
.artist-img img{width:100%;height:100%;object-fit:cover}

/* ===== AUTH ===== */
.auth-container{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;text-align:center;gap:24px}
.auth-form{width:100%;max-width:400px;padding:0 16px}
.auth-form .md-input{margin-bottom:12px;border-radius:var(--md-shape-md)}
.auth-tabs{display:flex;margin-bottom:24px;border-radius:var(--md-shape-full);overflow:hidden;border:1px solid var(--md-outline-variant)}
.auth-tab{flex:1;padding:10px 16px;font:500 14px/20px 'Inter',sans-serif;cursor:pointer;background:transparent;color:var(--md-on-surface-variant);border:none;transition:all .3s cubic-bezier(.2,0,0,1);text-align:center;user-select:none}
.auth-tab.active{background:var(--md-primary);color:var(--md-on-primary)}
.auth-divider{display:flex;align-items:center;gap:16px;margin:20px 0;font:400 13px/18px 'Inter',sans-serif;color:var(--md-on-surface-variant)}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--md-outline-variant)}
.telegram-btn-wrap{display:flex;justify-content:center;margin-top:8px}
.tg-login-btn{display:inline-flex;align-items:center;gap:10px;padding:12px 28px;border-radius:var(--md-shape-full);background:#54A9EB;color:white;border:none;font:500 14px/20px 'Inter',sans-serif;cursor:pointer;transition:all .25s cubic-bezier(.2,0,0,1);box-shadow:var(--md-elevation-1);user-select:none}
.tg-login-btn:hover{box-shadow:var(--md-elevation-2);filter:brightness(1.08);transform:translateY(-1px)}.tg-login-btn:active{transform:scale(.97)}
.tg-login-btn svg{width:22px;height:22px}
.password-wrap{position:relative}.password-wrap .md-input{padding-right:48px}
.password-toggle{position:absolute;right:4px;top:50%;transform:translateY(-50%);width:40px;height:40px;border:none;background:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--md-on-surface-variant);border-radius:50%;transition:all .2s}
.password-toggle:hover{background:var(--md-surface-container)}

/* ===== MISC ===== */
.skeleton{background:linear-gradient(90deg,var(--md-surface-container-high) 25%,var(--md-surface-container-highest) 50%,var(--md-surface-container-high) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:var(--md-shape-sm)}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.loading-spinner{width:40px;height:40px;border:3px solid var(--md-outline-variant);border-top-color:var(--md-primary);border-radius:50%;animation:spin .8s linear infinite;margin:40px auto}
@keyframes spin{to{transform:rotate(360deg)}}

.user-menu{position:absolute;top:56px;right:16px;background:var(--md-surface-container);border-radius:var(--md-shape-md);box-shadow:var(--md-elevation-3);min-width:220px;overflow:hidden;z-index:300;display:none;transform-origin:top right}
.user-menu.open{display:block;animation:menuIn .25s cubic-bezier(.2,0,0,1)}
@keyframes menuIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:none}}
.user-menu-item{display:flex;align-items:center;gap:12px;padding:12px 16px;font:400 14px/20px 'Inter',sans-serif;color:var(--md-on-surface);cursor:pointer;transition:background .2s}
.user-menu-item:hover{background:var(--md-surface-container-high)}

/* ===== HERO ===== */
.hero-banner{background:linear-gradient(135deg,var(--md-primary-container),var(--md-tertiary-container));border-radius:var(--md-shape-xl);padding:40px;margin-bottom:32px;position:relative;overflow:hidden;transition:transform .3s}
.hero-banner:hover{transform:scale(1.005)}
.hero-banner::before{content:'‚ô™';position:absolute;right:40px;top:-20px;font-size:200px;opacity:.1;color:var(--md-primary);animation:heroNote 6s ease-in-out infinite}
@keyframes heroNote{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-10px) rotate(5deg)}}
.hero-banner::after{content:'‚ô´';position:absolute;right:180px;bottom:-30px;font-size:120px;opacity:.07;color:var(--md-primary);animation:heroNote2 8s ease-in-out infinite}
@keyframes heroNote2{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-8px) rotate(-5deg)}}
.hero-title{font:800 32px/40px 'Inter',sans-serif;color:var(--md-on-primary-container);margin-bottom:8px}
.hero-sub{font:400 16px/24px 'Inter',sans-serif;color:var(--md-on-primary-container);opacity:.8;margin-bottom:24px}

/* ===== ARTIST PAGE ===== */
.artist-page-header{display:flex;align-items:flex-end;gap:24px;padding:32px 0 24px;flex-wrap:wrap}
.artist-page-avatar{width:180px;height:180px;border-radius:50%;background:var(--md-primary-container);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;box-shadow:var(--md-elevation-3);transition:transform .3s}
.artist-page-avatar:hover{transform:scale(1.05)}
.artist-page-avatar img{width:100%;height:100%;object-fit:cover}

/* ===== TABS ===== */
.tab-bar{display:flex;gap:0;border-bottom:1px solid var(--md-outline-variant);margin-bottom:24px;overflow-x:auto}
.tab-item{padding:12px 24px;font:500 14px/20px 'Inter',sans-serif;color:var(--md-on-surface-variant);cursor:pointer;border-bottom:2px solid transparent;transition:all .25s cubic-bezier(.2,0,0,1);white-space:nowrap;user-select:none;position:relative}
.tab-item:hover{color:var(--md-on-surface);background:var(--md-surface-container)}
.tab-item.active{color:var(--md-primary);border-bottom-color:var(--md-primary)}

/* ===== EMPTY STATE ===== */
.empty-state{text-align:center;padding:60px 20px;color:var(--md-on-surface-variant)}
.empty-state .material-symbols-rounded{font-size:64px;margin-bottom:16px;opacity:.5;animation:emptyFloat 3s ease-in-out infinite}
@keyframes emptyFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.empty-state h3{font:600 18px/24px 'Inter',sans-serif;margin-bottom:8px;color:var(--md-on-surface)}
.empty-state p{font:400 14px/20px 'Inter',sans-serif;max-width:400px;margin:0 auto}

.auth-error{color:var(--md-error);font:400 13px/18px 'Inter',sans-serif;margin-bottom:12px;min-height:18px}

/* ===== FULLSCREEN PLAYER ===== */
.fs-player-overlay{display:none;position:fixed;inset:0;background:var(--md-surface);z-index:600;flex-direction:column;overflow-y:auto}
.fs-player-overlay.open{display:flex;animation:fsIn .4s cubic-bezier(.2,0,0,1)}
@keyframes fsIn{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:none}}
.fs-top{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
.fs-cover-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:24px}
.fs-cover{width:100%;max-width:360px;aspect-ratio:1;border-radius:var(--md-shape-lg);background:var(--md-surface-container-highest);display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:var(--md-elevation-3);transition:border-radius .5s cubic-bezier(.2,0,0,1),transform .3s}
.fs-cover.playing{border-radius:24px;animation:coverPulse 4s ease-in-out infinite}
@keyframes coverPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
.fs-cover img{width:100%;height:100%;object-fit:cover}
.fs-cover .material-symbols-rounded{font-size:96px;color:var(--md-outline)}
.fs-info{padding:0 24px;text-align:center}
.fs-title{font:700 24px/32px 'Inter',sans-serif;color:var(--md-on-surface);margin-bottom:4px;display:flex;align-items:center;justify-content:center;gap:8px}
.fs-artist{font:500 16px/24px 'Inter',sans-serif;color:var(--md-primary);cursor:pointer;transition:opacity .2s}
.fs-artist:hover{opacity:.7}
.fs-controls{padding:24px}
.fs-progress{display:flex;align-items:center;gap:8px;margin-bottom:16px}
.fs-progress .progress-track{flex:1;height:6px}
.fs-progress .progress-time{font:500 13px/18px 'Inter',sans-serif}
.fs-buttons{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:16px}
.fs-play-btn{width:64px;height:64px;border-radius:50%;background:var(--md-primary);color:var(--md-on-primary);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .25s cubic-bezier(.2,0,0,1)}
.fs-play-btn:hover{transform:scale(1.1);box-shadow:var(--md-elevation-3)}
.fs-play-btn:active{transform:scale(.95)}
.fs-play-btn .material-symbols-rounded{font-size:36px;transition:transform .2s}
.fs-actions{display:flex;align-items:center;justify-content:center;gap:12px;padding:0 24px 24px}

/* ===== SETTINGS ===== */
.settings-item{display:flex;align-items:center;gap:16px;padding:16px;border-radius:var(--md-shape-md);transition:all .25s cubic-bezier(.2,0,0,1);cursor:pointer}
.settings-item:hover{background:var(--md-surface-container);transform:translateX(4px)}
.settings-item .material-symbols-rounded{color:var(--md-on-surface-variant);font-size:24px}
.settings-item-info{flex:1;min-width:0}
.settings-item-title{font:500 14px/20px 'Inter',sans-serif;color:var(--md-on-surface)}
.settings-item-sub{font:400 12px/16px 'Inter',sans-serif;color:var(--md-on-surface-variant);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ===== SEARCH ===== */
.search-section{margin-bottom:24px}
.search-section-title{font:600 16px/24px 'Inter',sans-serif;color:var(--md-on-surface);margin-bottom:12px;display:flex;align-items:center;gap:8px}

/* ===== COVER UPLOAD ===== */
.cover-upload-zone{width:120px;height:120px;border:2px dashed var(--md-outline-variant);border-radius:var(--md-shape-md);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .3s cubic-bezier(.2,0,0,1);overflow:hidden;flex-shrink:0}
.cover-upload-zone:hover{border-color:var(--md-primary);background:rgba(103,80,164,.05);transform:scale(1.03)}
.cover-upload-zone img{width:100%;height:100%;object-fit:cover}
.cover-upload-zone .material-symbols-rounded{font-size:32px;color:var(--md-primary)}

/* ===== CONTEXT MENU ===== */
.track-context-menu{position:fixed;background:var(--md-surface-container);border-radius:var(--md-shape-md);box-shadow:var(--md-elevation-3);min-width:220px;z-index:700;overflow:hidden;animation:menuIn .2s cubic-bezier(.2,0,0,1)}
.track-context-item{display:flex;align-items:center;gap:12px;padding:12px 16px;font:400 14px/20px 'Inter',sans-serif;color:var(--md-on-surface);cursor:pointer;transition:background .15s}
.track-context-item:hover{background:var(--md-surface-container-high)}
.track-context-item .material-symbols-rounded{font-size:20px;color:var(--md-on-surface-variant)}
.track-context-item.danger{color:var(--md-error)}
.track-context-item.danger .material-symbols-rounded{color:var(--md-error)}

/* ===== QUEUE PANEL ===== */
.queue-panel{position:fixed;right:0;top:0;bottom:0;width:360px;background:var(--md-surface-container);z-index:500;transform:translateX(100%);transition:transform .4s cubic-bezier(.2,0,0,1);box-shadow:var(--md-elevation-3);display:flex;flex-direction:column;overflow:hidden}
.queue-panel.open{transform:translateX(0)}
.queue-panel-header{display:flex;align-items:center;gap:12px;padding:16px;border-bottom:1px solid var(--md-outline-variant)}
.queue-panel-header .section-title{margin:0;flex:1}
.queue-panel-body{flex:1;overflow-y:auto;padding:8px}
.queue-track{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:var(--md-shape-sm);cursor:pointer;transition:background .2s}
.queue-track:hover{background:var(--md-surface-container-high)}
.queue-track.active{background:var(--md-primary-container)}
.queue-track-thumb{width:40px;height:40px;border-radius:6px;background:var(--md-surface-container-highest);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.queue-track-thumb img{width:100%;height:100%;object-fit:cover}
.queue-track-info{flex:1;min-width:0}
.queue-track-name{font:500 13px/18px 'Inter',sans-serif;color:var(--md-on-surface);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.queue-track-artist{font:400 11px/16px 'Inter',sans-serif;color:var(--md-on-surface-variant);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ===== LYRICS PANEL ===== */
.lyrics-container{padding:24px;text-align:center;font:400 18px/32px 'Inter',sans-serif;color:var(--md-on-surface-variant);white-space:pre-wrap;min-height:200px}

/* ===== STATS CARD ===== */
.stat-card{background:var(--md-surface-container);border-radius:var(--md-shape-md);padding:20px;text-align:center;transition:all .3s}
.stat-card:hover{transform:translateY(-2px);box-shadow:var(--md-elevation-1)}
.stat-value{font:700 28px/36px 'Inter',sans-serif;color:var(--md-primary)}
.stat-label{font:400 13px/18px 'Inter',sans-serif;color:var(--md-on-surface-variant);margin-top:4px}

/* ===== RESPONSIVE ===== */
@media(max-width:1024px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .sidebar-overlay.open{display:block}
  .main-content{margin-left:0;padding-bottom:calc(var(--player-height) + var(--nav-height) + 24px)}
  .top-bar .menu-btn{display:flex}
  .bottom-nav{display:flex}
  .player-bar{bottom:var(--nav-height)}
  .player-volume{display:none}
  .player-track-info{min-width:100px;max-width:160px}
  .queue-panel{width:100%}
}
@media(max-width:600px){
  .page{padding:12px 16px}
  .top-bar{padding:8px 12px}
  .cards-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
  .hero-banner{padding:24px}
  .hero-title{font-size:24px;line-height:32px}
  .profile-header{flex-direction:column;text-align:center}
  .profile-stats{justify-content:center}
  .player-controls{flex:3}
  .player-track-info{min-width:70px;max-width:120px}
  .progress-time{display:none}
  .artist-page-header{flex-direction:column;align-items:center;text-align:center}
  .artist-page-avatar{width:120px;height:120px}
  .wave-circle{width:150px;height:150px}
  .wave-circle .material-symbols-rounded{font-size:48px}
  .modal{padding:20px;max-width:100%}
  .fs-cover{max-width:280px}
}
</style>
</head>
<body>

<!-- ===== SIDEBAR ===== -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">‚ô™</div>
    <span class="sidebar-brand">MusicPlatforme</span>
    <button class="btn-icon" onclick="toggleSidebar()" style="margin-left:auto;display:none" id="sidebarCloseBtn"><span class="material-symbols-rounded">close</span></button>
  </div>
  <nav>
    <a class="nav-item active" data-page="home" onclick="navigate('home')"><span class="material-symbols-rounded">home</span> –ì–ª–∞–≤–Ω–∞—è</a>
    <a class="nav-item" data-page="explore" onclick="navigate('explore')"><span class="material-symbols-rounded">explore</span> –û–±–∑–æ—Ä</a>
    <a class="nav-item" data-page="wave" onclick="navigate('wave')"><span class="material-symbols-rounded">waves</span> –ú–æ—è –≤–æ–ª–Ω–∞</a>
    <a class="nav-item" data-page="charts" onclick="navigate('charts')"><span class="material-symbols-rounded">trending_up</span> –ß–∞—Ä—Ç—ã</a>
    <a class="nav-item" data-page="new-releases" onclick="navigate('new-releases')"><span class="material-symbols-rounded">new_releases</span> –ù–æ–≤–∏–Ω–∫–∏</a>
    <div class="nav-divider"></div>
    <a class="nav-item" data-page="favorites" onclick="navigate('favorites')"><span class="material-symbols-rounded">favorite</span> –õ—é–±–∏–º–æ–µ</a>
    <a class="nav-item" data-page="playlists" onclick="navigate('playlists')"><span class="material-symbols-rounded">queue_music</span> –ü–ª–µ–π–ª–∏—Å—Ç—ã</a>
    <a class="nav-item" data-page="history" onclick="navigate('history')"><span class="material-symbols-rounded">history</span> –ò—Å—Ç–æ—Ä–∏—è</a>
    <a class="nav-item" data-page="subscriptions" onclick="navigate('subscriptions')"><span class="material-symbols-rounded">people</span> –ü–æ–¥–ø–∏—Å–∫–∏</a>
    <div class="nav-divider"></div>
    <a class="nav-item" data-page="upload" onclick="navigate('upload')"><span class="material-symbols-rounded">upload</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å</a>
    <a class="nav-item" data-page="profile" onclick="navigate('profile')"><span class="material-symbols-rounded">person</span> –ü—Ä–æ—Ñ–∏–ª—å</a>
  </nav>
</aside>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- ===== MAIN CONTENT ===== -->
<div class="main-content" id="mainContent">
  <header class="top-bar" id="topBar">
    <button class="btn-icon menu-btn" onclick="toggleSidebar()"><span class="material-symbols-rounded">menu</span></button>
    <div class="search-bar">
      <span class="material-symbols-rounded">search</span>
      <input type="text" placeholder="–ü–æ–∏—Å–∫ –º—É–∑—ã–∫–∏, –∞—Ä—Ç–∏—Å—Ç–æ–≤, –∂–∞–Ω—Ä–æ–≤..." id="searchInput" oninput="handleSearch(this.value)">
    </div>
    <div class="user-area">
      <button class="btn-icon" onclick="toggleQueue()" title="–û—á–µ—Ä–µ–¥—å"><span class="material-symbols-rounded">queue_music</span></button>
      <button class="btn-icon" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É"><span class="material-symbols-rounded" id="themeIcon">dark_mode</span></button>
      <div class="user-avatar" id="userAvatarBtn" onclick="toggleUserMenu()">
        <span class="material-symbols-rounded" id="avatarIcon">person</span>
        <img id="avatarImg" style="display:none" alt="">
      </div>
    </div>
  </header>
  <div class="user-menu" id="userMenu"><div id="userMenuContent"></div></div>

  <!-- HOME -->
  <div class="page active" id="page-home">
    <div class="hero-banner">
      <div class="hero-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ MusicPlatforme</div>
      <div class="hero-sub">–°–ª—É—à–∞–π, –æ—Ç–∫—Ä—ã–≤–∞–π –∏ –¥–µ–ª–∏—Å—å –º—É–∑—ã–∫–æ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
      <button class="btn-primary" onclick="navigate('wave')"><span class="material-symbols-rounded">waves</span> –ú–æ—è –≤–æ–ª–Ω–∞</button>
    </div>
    <div class="section-title">üî• –ù–æ–≤—ã–µ —Ç—Ä–µ–∫–∏</div>
    <div class="track-list" id="homeNewTracks"><div class="loading-spinner"></div></div>
    <div class="section-title">üèÜ –ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</div>
    <div class="cards-grid" id="homePopular"><div class="skeleton" style="height:220px"></div><div class="skeleton" style="height:220px"></div><div class="skeleton" style="height:220px"></div><div class="skeleton" style="height:220px"></div></div>
    <div class="section-title">üé§ –ê—Ä—Ç–∏—Å—Ç—ã</div>
    <div class="cards-grid" id="homeArtists" style="grid-template-columns:repeat(auto-fill,minmax(120px,1fr))"></div>
  </div>

  <!-- EXPLORE -->
  <div class="page" id="page-explore">
    <div class="section-title">–û–±–∑–æ—Ä</div>
    <div class="genre-pills" id="genrePills"></div>
    <div class="section-title" id="exploreTitle">–í—Å–µ —Ç—Ä–µ–∫–∏</div>
    <div class="track-list" id="exploreTracks"><div class="loading-spinner"></div></div>
  </div>

  <!-- WAVE -->
  <div class="page" id="page-wave">
    <div class="wave-container" id="waveContainer">
      <div class="wave-circle" id="waveCircle"><span class="material-symbols-rounded filled">waves</span></div>
      <div class="section-title">–ú–æ—è –≤–æ–ª–Ω–∞</div>
      <p class="section-sub">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Ä–∞–¥–∏–æ—Å—Ç–∞–Ω—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Ç–≤–æ–∏ –≤–∫—É—Å—ã</p>
      <button class="btn-primary" onclick="startWave()" id="waveBtn"><span class="material-symbols-rounded">play_arrow</span> –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ–ª–Ω—É</button>
    </div>
    <div class="track-list" id="waveTracks" style="margin-top:24px"></div>
  </div>

  <!-- CHARTS -->
  <div class="page" id="page-charts">
    <div class="section-title">üìä –ß–∞—Ä—Ç—ã</div>
    <div class="section-sub">–°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç—Ä–µ–∫–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</div>
    <div class="track-list" id="chartsTracks"><div class="loading-spinner"></div></div>
  </div>

  <!-- NEW RELEASES -->
  <div class="page" id="page-new-releases">
    <div class="section-title">üÜï –ù–æ–≤–∏–Ω–∫–∏</div>
    <div class="section-sub">–°–≤–µ–∂–∏–µ —Ä–µ–ª–∏–∑—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
    <div class="track-list" id="newReleasesTracks"><div class="loading-spinner"></div></div>
  </div>

  <!-- FAVORITES -->
  <div class="page" id="page-favorites">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px">
      <div class="section-title" style="margin-bottom:0">‚ù§Ô∏è –õ—é–±–∏–º–æ–µ</div>
      <div style="display:flex;gap:8px">
        <button class="btn-tonal" id="playAllFavBtn" style="display:none" onclick="playAllFavorites()"><span class="material-symbols-rounded">play_arrow</span> –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
        <button class="btn-tonal" id="shuffleFavBtn" style="display:none" onclick="shuffleFavorites()"><span class="material-symbols-rounded">shuffle</span> –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
      </div>
    </div>
    <div id="favContent">
      <div class="empty-state" id="favEmpty"><span class="material-symbols-rounded">favorite</span><h3>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</h3><p>–ù–∞–∂–º–∏—Ç–µ ‚ô° –Ω–∞ –ª—é–±–æ–º —Ç—Ä–µ–∫–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –≤ –ª—é–±–∏–º–æ–µ</p></div>
      <div class="track-list" id="favTracks"></div>
    </div>
  </div>

  <!-- PLAYLISTS -->
  <div class="page" id="page-playlists">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px">
      <div class="section-title" style="margin-bottom:0">üéµ –ü–ª–µ–π–ª–∏—Å—Ç—ã</div>
      <button class="btn-tonal" onclick="createPlaylist()"><span class="material-symbols-rounded">add</span> –°–æ–∑–¥–∞—Ç—å</button>
    </div>
    <div id="playlistsContent"><div class="empty-state"><span class="material-symbols-rounded">queue_music</span><h3>–ù–µ—Ç –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤</h3><p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç</p></div></div>
    <div class="cards-grid" id="playlistsGrid"></div>
  </div>

  <!-- HISTORY -->
  <div class="page" id="page-history">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px">
      <div class="section-title" style="margin-bottom:0">üìú –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è</div>
      <button class="btn-text" onclick="clearHistory()"><span class="material-symbols-rounded">delete</span> –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    <div id="historyContent"><div class="empty-state"><span class="material-symbols-rounded">history</span><h3>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</h3><p>–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ç—Ä–µ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —Å–ª—É—à–∞–ª–∏</p></div></div>
    <div class="track-list" id="historyTracks"></div>
  </div>

  <!-- SUBSCRIPTIONS -->
  <div class="page" id="page-subscriptions">
    <div class="section-title">üë• –ü–æ–¥–ø–∏—Å–∫–∏</div>
    <div id="subsContent"><div class="empty-state" id="subsEmpty"><span class="material-symbols-rounded">people</span><h3>–í—ã –Ω–∏ –Ω–∞ –∫–æ–≥–æ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã</h3><p>–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∞—Ä—Ç–∏—Å—Ç–æ–≤, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏—Ö –Ω–æ–≤—ã–µ —Ç—Ä–µ–∫–∏</p></div></div>
    <div class="cards-grid" id="subsGrid" style="grid-template-columns:repeat(auto-fill,minmax(120px,1fr))"></div>
    <div class="section-title" id="subsFeedTitle" style="display:none;margin-top:32px">–ù–æ–≤—ã–µ —Ç—Ä–µ–∫–∏ –æ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</div>
    <div class="track-list" id="subsFeedTracks"></div>
  </div>

  <!-- UPLOAD -->
  <div class="page" id="page-upload">
    <div class="section-title">‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–∫</div>
    <div id="uploadAuthMsg" style="display:none"><div class="empty-state"><span class="material-symbols-rounded">lock</span><h3>–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3><p>–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –º—É–∑—ã–∫—É</p><button class="btn-primary" onclick="navigate('profile')" style="margin-top:20px"><span class="material-symbols-rounded">login</span> –í–æ–π—Ç–∏</button></div></div>
    <div id="uploadForm" style="display:none">
      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('audioFileInput').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="handleAudioDrop(event)">
        <span class="material-symbols-rounded">cloud_upload</span>
        <div style="font:500 16px/24px 'Inter',sans-serif;color:var(--md-on-surface);position:relative;z-index:1">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª —Å—é–¥–∞</div>
        <div style="font:400 13px/18px 'Inter',sans-serif;color:var(--md-on-surface-variant);margin-top:4px;position:relative;z-index:1">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ (MP3, WAV, OGG, –¥–æ 15 –ú–ë)</div>
      </div>
      <input type="file" id="audioFileInput" accept="audio/*" style="display:none" onchange="handleAudioSelect(event)">
      <div id="selectedFileInfo" style="display:none;margin-bottom:16px;padding:12px;background:var(--md-surface-container-highest);border-radius:var(--md-shape-md)">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="material-symbols-rounded" style="color:var(--md-primary)">audio_file</span>
          <span id="selectedFileName" style="font:500 14px/20px 'Inter',sans-serif"></span>
          <button class="btn-icon" onclick="clearSelectedFile()" style="margin-left:auto"><span class="material-symbols-rounded">close</span></button>
        </div>
      </div>
      <label class="modal-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ *</label>
      <input class="md-input" id="uploadTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞" style="border-radius:var(--md-shape-md);margin-bottom:16px">
      <label class="modal-label">–ñ–∞–Ω—Ä</label>
      <select class="md-input" id="uploadGenre" style="border-radius:var(--md-shape-md);margin-bottom:8px;cursor:pointer">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä</option>
        <option value="pop">–ü–æ–ø</option><option value="rock">–†–æ–∫</option><option value="hiphop">–•–∏–ø-—Ö–æ–ø</option>
        <option value="electronic">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è</option><option value="rnb">R&B</option><option value="jazz">–î–∂–∞–∑</option>
        <option value="classical">–ö–ª–∞—Å—Å–∏–∫–∞</option><option value="indie">–ò–Ω–¥–∏</option><option value="metal">–ú–µ—Ç–∞–ª</option>
        <option value="phonk">Phonk</option><option value="lofi">Lo-Fi</option><option value="dnb">Drum & Bass</option>
        <option value="house">House</option><option value="techno">Techno</option><option value="trap">Trap</option>
        <option value="reggaeton">Reggaeton</option><option value="kpop">K-Pop</option>
        <option value="custom">–°–≤–æ–π –∂–∞–Ω—Ä...</option>
      </select>
      <input class="md-input" id="uploadCustomGenre" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –∂–∞–Ω—Ä" style="border-radius:var(--md-shape-md);margin-bottom:16px;display:none">
      <label class="modal-label">–û–±–ª–æ–∂–∫–∞</label>
      <div style="display:flex;gap:16px;align-items:flex-start;margin-bottom:16px;flex-wrap:wrap">
        <div class="cover-upload-zone" id="coverUploadZone" onclick="document.getElementById('coverFileInput').click()">
          <span class="material-symbols-rounded">image</span>
          <span style="font:400 11px/14px 'Inter',sans-serif;color:var(--md-on-surface-variant);text-align:center;padding:0 4px">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span>
        </div>
        <div style="flex:1;min-width:200px">
          <input class="md-input" id="uploadCover" placeholder="–∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" style="border-radius:var(--md-shape-md)">
          <input type="file" id="coverFileInput" accept="image/*" style="display:none" onchange="handleCoverSelect(event)">
        </div>
      </div>
      <label class="modal-label">–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea class="md-input" id="uploadLyrics" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏..." rows="4" style="border-radius:var(--md-shape-md);margin-bottom:16px;resize:vertical"></textarea>
      <div id="uploadProgress" style="display:none;margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <div class="loading-spinner" style="width:20px;height:20px;margin:0;border-width:2px"></div>
          <span style="font:400 14px/20px 'Inter',sans-serif;color:var(--md-on-surface-variant)" id="uploadStatusText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <div style="height:4px;background:var(--md-outline-variant);border-radius:2px;overflow:hidden"><div id="uploadProgressBar" style="height:100%;background:var(--md-primary);width:0%;transition:width .5s cubic-bezier(.2,0,0,1)"></div></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn-primary" onclick="publishTrack()" id="publishBtn"><span class="material-symbols-rounded">publish</span> –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
      </div>
      <div class="section-title" style="margin-top:40px">–ú–æ–∏ —Ç—Ä–µ–∫–∏</div>
      <div class="track-list" id="myTracks"></div>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="page" id="page-profile">
    <div id="profileAuthMsg">
      <div class="auth-container">
        <span class="material-symbols-rounded" style="font-size:80px;color:var(--md-primary)">account_circle</span>
        <div class="section-title" style="margin-bottom:0">–í–æ–π–¥–∏—Ç–µ –≤ MusicPlatforme</div>
        <p class="section-sub" style="max-width:400px;margin-bottom:0">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –º—É–∑—ã–∫—É, —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏ –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å—Å—è</p>
        <div class="auth-form">
          <div class="auth-tabs">
            <button class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">–í—Ö–æ–¥</button>
            <button class="auth-tab" id="tabRegister" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          </div>
          <div id="loginForm">
            <input class="md-input" id="loginIdentity" placeholder="–õ–æ–≥–∏–Ω –∏–ª–∏ Email" autocomplete="username">
            <div class="password-wrap"><input class="md-input" id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password"><button class="password-toggle" onclick="togglePasswordVis('loginPassword',this)" type="button"><span class="material-symbols-rounded">visibility_off</span></button></div>
            <div class="auth-error" id="loginError"></div>
            <button class="btn-primary" style="width:100%;justify-content:center" onclick="doLogin()"><span class="material-symbols-rounded">login</span> –í–æ–π—Ç–∏</button>
          </div>
          <div id="registerForm" style="display:none">
            <input class="md-input" id="regUsername" placeholder="–õ–æ–≥–∏–Ω (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)" autocomplete="username">
            <input class="md-input" id="regEmail" placeholder="Email" type="email" autocomplete="email">
            <input class="md-input" id="regDisplayName" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è">
            <div class="password-wrap"><input class="md-input" id="regPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" autocomplete="new-password"><button class="password-toggle" onclick="togglePasswordVis('regPassword',this)" type="button"><span class="material-symbols-rounded">visibility_off</span></button></div>
            <div class="password-wrap"><input class="md-input" id="regPassword2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="new-password"><button class="password-toggle" onclick="togglePasswordVis('regPassword2',this)" type="button"><span class="material-symbols-rounded">visibility_off</span></button></div>
            <div class="auth-error" id="regError"></div>
            <button class="btn-primary" style="width:100%;justify-content:center" onclick="doRegister()"><span class="material-symbols-rounded">person_add</span> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
          </div>
          <div class="auth-divider">–∏–ª–∏</div>
          <div class="telegram-btn-wrap">
            <button class="tg-login-btn" onclick="openTelegramLogin()">
              <svg viewBox="0 0 24 24" fill="white"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
              –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram
            </button>
          </div>
        </div>
      </div>
    </div>
    <div id="profileContent" style="display:none">
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar"><span class="material-symbols-rounded">person</span></div>
        <div class="profile-info">
          <div class="profile-name" id="profileName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
          <div style="font:400 13px/18px 'Inter',sans-serif;color:var(--md-on-surface-variant);margin-top:2px" id="profileLogin">@user</div>
          <div class="profile-stats">
            <span><strong id="profileTracks">0</strong> —Ç—Ä–µ–∫–æ–≤</span>
            <span><strong id="profileLikes">0</strong> –ª–∞–π–∫–æ–≤</span>
            <span><strong id="profileSubs">0</strong> –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</span>
          </div>
          <div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
            <button class="btn-tonal" onclick="openSettings()"><span class="material-symbols-rounded">settings</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="btn-outlined" onclick="signOutUser()"><span class="material-symbols-rounded">logout</span> –í—ã–π—Ç–∏</button>
          </div>
        </div>
      </div>
      <!-- Stats -->
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:24px" id="profileStatsGrid"></div>
      <div class="tab-bar">
        <div class="tab-item active" onclick="switchProfileTab('tracks',this)">–¢—Ä–µ–∫–∏</div>
        <div class="tab-item" onclick="switchProfileTab('liked',this)">–ü–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è</div>
        <div class="tab-item" onclick="switchProfileTab('stats',this)">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      </div>
      <div id="profileTabContent"><div class="track-list" id="profileTrackList"><div class="loading-spinner"></div></div></div>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="page" id="page-search">
    <div class="section-title" id="searchTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</div>
    <div id="searchArtistsSection" class="search-section" style="display:none">
      <div class="search-section-title"><span class="material-symbols-rounded">person</span> –ê—Ä—Ç–∏—Å—Ç—ã</div>
      <div class="cards-grid" id="searchArtists" style="grid-template-columns:repeat(auto-fill,minmax(120px,1fr))"></div>
    </div>
    <div id="searchTracksSection" class="search-section">
      <div class="search-section-title"><span class="material-symbols-rounded">music_note</span> –¢—Ä–µ–∫–∏</div>
      <div class="track-list" id="searchResults"></div>
    </div>
  </div>

  <!-- ARTIST -->
  <div class="page" id="page-artist">
    <div class="artist-page-header" id="artistHeader"></div>
    <div class="tab-bar" id="artistTabs" style="display:none">
      <div class="tab-item active" onclick="switchArtistTab('tracks',this)">–¢—Ä–µ–∫–∏</div>
      <div class="tab-item" onclick="switchArtistTab('popular',this)">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</div>
    </div>
    <div class="track-list" id="artistTracks"></div>
  </div>

  <!-- PLAYLIST VIEW -->
  <div class="page" id="page-playlist-view">
    <div id="playlistViewHeader"></div>
    <div class="track-list" id="playlistViewTracks"></div>
  </div>
</div>

<!-- ===== BOTTOM NAV ===== -->
<div class="bottom-nav" id="bottomNav">
  <button class="nav-tab active" data-page="home" onclick="navigate('home')"><div class="nav-tab-indicator"><span class="material-symbols-rounded">home</span></div>–ì–ª–∞–≤–Ω–∞—è</button>
  <button class="nav-tab" data-page="explore" onclick="navigate('explore')"><div class="nav-tab-indicator"><span class="material-symbols-rounded">explore</span></div>–û–±–∑–æ—Ä</button>
  <button class="nav-tab" data-page="wave" onclick="navigate('wave')"><div class="nav-tab-indicator"><span class="material-symbols-rounded">waves</span></div>–í–æ–ª–Ω–∞</button>
  <button class="nav-tab" data-page="favorites" onclick="navigate('favorites')"><div class="nav-tab-indicator"><span class="material-symbols-rounded">favorite</span></div>–õ—é–±–∏–º–æ–µ</button>
  <button class="nav-tab" data-page="profile" onclick="navigate('profile')"><div class="nav-tab-indicator"><span class="material-symbols-rounded">person</span></div>–ü—Ä–æ—Ñ–∏–ª—å</button>
</div>

<!-- ===== PLAYER BAR ===== -->
<div class="player-bar" id="playerBar">
  <div class="player-track-info" onclick="openFullscreenPlayer()">
    <div class="player-thumb" id="playerThumb"><span class="material-symbols-rounded">music_note</span></div>
    <div class="player-meta">
      <div class="player-title-row"><div class="player-song" id="playerSong">‚Äî</div><span class="explicit-badge" id="playerExplicit" style="display:none" title="Explicit">!</span></div>
      <div class="player-artist-name" id="playerArtist">‚Äî</div>
    </div>
  </div>
  <div class="player-controls">
    <div class="player-buttons">
      <button class="btn-icon" onclick="toggleShuffle()" id="shuffleBtn"><span class="material-symbols-rounded">shuffle</span></button>
      <button class="btn-icon" onclick="prevTrack()"><span class="material-symbols-rounded">skip_previous</span></button>
      <button class="player-play-btn" onclick="togglePlay()" id="mainPlayBtn"><span class="material-symbols-rounded" id="playIcon">play_arrow</span></button>
      <button class="btn-icon" onclick="nextTrack()"><span class="material-symbols-rounded">skip_next</span></button>
      <button class="btn-icon" onclick="toggleRepeat()" id="repeatBtn"><span class="material-symbols-rounded">repeat</span></button>
    </div>
    <div class="progress-bar">
      <span class="progress-time" id="currentTime">0:00</span>
      <div class="progress-track" id="progressTrack"><div class="progress-buffered" id="progressBuffered"></div><div class="progress-fill" id="progressFill"></div></div>
      <span class="progress-time" id="totalTime">0:00</span>
    </div>
  </div>
  <div class="player-volume">
    <button class="btn-icon" onclick="toggleMute()" id="volumeBtn"><span class="material-symbols-rounded">volume_up</span></button>
    <div class="volume-slider" id="volumeSlider"><div class="volume-fill" id="volumeFill"></div></div>
  </div>
</div>

<!-- ===== FULLSCREEN PLAYER ===== -->
<div class="fs-player-overlay" id="fsPlayer">
  <div class="fs-top">
    <button class="btn-icon" onclick="closeFullscreenPlayer()"><span class="material-symbols-rounded">keyboard_arrow_down</span></button>
    <div style="font:600 14px/20px 'Inter',sans-serif;color:var(--md-on-surface)">–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç</div>
    <button class="btn-icon" onclick="showContextMenuForCurrent(event)"><span class="material-symbols-rounded">more_vert</span></button>
  </div>
  <div class="fs-cover-wrap">
    <div class="fs-cover" id="fsCover"><span class="material-symbols-rounded">music_note</span></div>
  </div>
  <div class="fs-info">
    <div class="fs-title" id="fsTitle">‚Äî</div>
    <div class="fs-artist" id="fsArtist" onclick="fsGoToArtist()">‚Äî</div>
  </div>
  <div class="fs-controls">
    <div class="fs-progress">
      <span class="progress-time" id="fsCurrentTime">0:00</span>
      <div class="progress-track" id="fsProgressTrack"><div class="progress-fill" id="fsProgressFill"></div></div>
      <span class="progress-time" id="fsTotalTime">0:00</span>
    </div>
    <div class="fs-buttons">
      <button class="btn-icon" onclick="toggleShuffle()" id="fsShuffleBtn"><span class="material-symbols-rounded">shuffle</span></button>
      <button class="btn-icon" onclick="prevTrack()" style="width:48px;height:48px"><span class="material-symbols-rounded" style="font-size:32px">skip_previous</span></button>
      <button class="fs-play-btn" onclick="togglePlay()" id="fsPlayBtn"><span class="material-symbols-rounded" id="fsPlayIcon">play_arrow</span></button>
      <button class="btn-icon" onclick="nextTrack()" style="width:48px;height:48px"><span class="material-symbols-rounded" style="font-size:32px">skip_next</span></button>
      <button class="btn-icon" onclick="toggleRepeat()" id="fsRepeatBtn"><span class="material-symbols-rounded">repeat</span></button>
    </div>
  </div>
  <div class="fs-actions">
    <button class="btn-icon" id="fsLikeBtn" onclick="toggleFavorite(currentTrackId)"><span class="material-symbols-rounded">favorite</span></button>
    <button class="btn-icon" onclick="fsGoToArtist()" title="–ü—Ä–æ—Ñ–∏–ª—å –∞—Ä—Ç–∏—Å—Ç–∞"><span class="material-symbols-rounded">person</span></button>
    <button class="btn-icon" onclick="shareTrack()" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"><span class="material-symbols-rounded">share</span></button>
    <button class="btn-icon" onclick="addToPlaylistPrompt()" title="–í –ø–ª–µ–π–ª–∏—Å—Ç"><span class="material-symbols-rounded">playlist_add</span></button>
    <button class="btn-icon" onclick="toggleLyrics()" title="–¢–µ–∫—Å—Ç"><span class="material-symbols-rounded">lyrics</span></button>
    <button class="btn-icon" onclick="toggleQueue()" title="–û—á–µ—Ä–µ–¥—å"><span class="material-symbols-rounded">queue_music</span></button>
  </div>
  <div class="lyrics-container" id="fsLyrics" style="display:none"></div>
</div>

<!-- ===== QUEUE PANEL ===== -->
<div class="queue-panel" id="queuePanel">
  <div class="queue-panel-header">
    <div class="section-title">–û—á–µ—Ä–µ–¥—å</div>
    <button class="btn-icon" onclick="clearQueue()"><span class="material-symbols-rounded">delete_sweep</span></button>
    <button class="btn-icon" onclick="toggleQueue()"><span class="material-symbols-rounded">close</span></button>
  </div>
  <div class="queue-panel-body" id="queueBody"></div>
</div>

<!-- ===== MODALS ===== -->
<div class="modal-overlay" id="playlistModal"><div class="modal">
  <div class="modal-title">–ù–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç</div>
  <label class="modal-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
  <input class="md-input" id="playlistNameInput" placeholder="–ú–æ–π –ø–ª–µ–π–ª–∏—Å—Ç">
  <label class="modal-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
  <input class="md-input" id="playlistDescInput" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞">
  <div class="modal-actions"><button class="btn-outlined" onclick="closeModal('playlistModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn-primary" onclick="savePlaylist()">–°–æ–∑–¥–∞—Ç—å</button></div>
</div></div>

<div class="modal-overlay" id="deleteModal"><div class="modal">
  <div class="modal-title">–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–∫?</div>
  <p style="font:400 14px/20px 'Inter',sans-serif;color:var(--md-on-surface-variant);margin-bottom:16px">–≠—Ç–æ—Ç —Ç—Ä–µ–∫ –±—É–¥–µ—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª—ë–Ω.</p>
  <div class="modal-actions"><button class="btn-outlined" onclick="closeModal('deleteModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn-primary" style="background:var(--md-error);color:var(--md-on-error)" onclick="confirmDeleteTrack()">–£–¥–∞–ª–∏—Ç—å</button></div>
</div></div>

<div class="modal-overlay" id="settingsModal"><div class="modal" style="max-width:520px">
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
    <button class="btn-icon" onclick="closeModal('settingsModal')"><span class="material-symbols-rounded">arrow_back</span></button>
    <div class="modal-title" style="margin-bottom:0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
  </div>
  <div id="settingsContent"></div>
</div></div>

<div class="modal-overlay" id="editProfileModal"><div class="modal">
  <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
  <div style="display:flex;justify-content:center;margin-bottom:16px">
    <div class="cover-upload-zone" style="width:100px;height:100px;border-radius:50%" id="editAvatarZone" onclick="document.getElementById('avatarFileInput').click()">
      <span class="material-symbols-rounded">add_a_photo</span>
    </div>
    <input type="file" id="avatarFileInput" accept="image/*" style="display:none" onchange="handleAvatarSelect(event)">
  </div>
  <label class="modal-label">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
  <input class="md-input" id="editDisplayName" placeholder="–ò–º—è">
  <label class="modal-label">–ê–≤–∞—Ç–∞—Ä (URL)</label>
  <input class="md-input" id="editAvatarUrl" placeholder="https://...">
  <label class="modal-label">–°—Ç–∞—Ç—É—Å / –ë–∏–æ</label>
  <input class="md-input" id="editBio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ...">
  <div class="modal-actions"><button class="btn-outlined" onclick="closeModal('editProfileModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn-primary" onclick="saveProfileEdits()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
</div></div>

<div class="modal-overlay" id="linkTelegramModal"><div class="modal">
  <div class="modal-title">–ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram</div>
  <p style="font:400 14px/20px 'Inter',sans-serif;color:var(--md-on-surface-variant);margin-bottom:16px">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏</p>
  <div class="telegram-btn-wrap"><button class="tg-login-btn" onclick="linkTelegram()"><svg viewBox="0 0 24 24" fill="white"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg> –ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram</button></div>
  <div class="modal-actions" style="margin-top:16px"><button class="btn-outlined" onclick="closeModal('linkTelegramModal')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<div class="modal-overlay" id="linkEmailModal"><div class="modal">
  <div class="modal-title">–ü—Ä–∏–≤—è–∑–∞—Ç—å Email</div>
  <label class="modal-label">Email</label>
  <input class="md-input" id="linkEmail" placeholder="email@example.com" type="email">
  <label class="modal-label">–ü–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞</label>
  <div class="password-wrap"><input class="md-input" id="linkPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)"><button class="password-toggle" onclick="togglePasswordVis('linkPassword',this)" type="button"><span class="material-symbols-rounded">visibility_off</span></button></div>
  <div class="auth-error" id="linkEmailError"></div>
  <div class="modal-actions"><button class="btn-outlined" onclick="closeModal('linkEmailModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn-primary" onclick="saveLinkEmail()">–ü—Ä–∏–≤—è–∑–∞—Ç—å</button></div>
</div></div>

<div class="modal-overlay" id="addToPlaylistModal"><div class="modal">
  <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–µ–π–ª–∏—Å—Ç</div>
  <div id="addToPlaylistList"></div>
  <div class="modal-actions" style="margin-top:16px"><button class="btn-outlined" onclick="closeModal('addToPlaylistModal')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<div class="modal-overlay" id="reportModal"><div class="modal">
  <div class="modal-title">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</div>
  <p style="font:400 14px/20px 'Inter',sans-serif;color:var(--md-on-surface-variant);margin-bottom:16px">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã:</p>
  <div id="reportReasons">
    <div class="settings-item" onclick="submitReport('copyright')"><span class="material-symbols-rounded">copyright</span><div class="settings-item-info"><div class="settings-item-title">–ù–∞—Ä—É—à–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤</div></div></div>
    <div class="settings-item" onclick="submitReport('spam')"><span class="material-symbols-rounded">report</span><div class="settings-item-info"><div class="settings-item-title">–°–ø–∞–º / –º—É—Å–æ—Ä</div></div></div>
    <div class="settings-item" onclick="submitReport('inappropriate')"><span class="material-symbols-rounded">block</span><div class="settings-item-info"><div class="settings-item-title">–ù–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</div></div></div>
    <div class="settings-item" onclick="submitReport('quality')"><span class="material-symbols-rounded">low_priority</span><div class="settings-item-info"><div class="settings-item-title">–ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ</div></div></div>
    <div class="settings-item" onclick="submitReport('other')"><span class="material-symbols-rounded">more_horiz</span><div class="settings-item-info"><div class="settings-item-title">–î—Ä—É–≥–æ–µ</div></div></div>
  </div>
  <div class="modal-actions" style="margin-top:12px"><button class="btn-outlined" onclick="closeModal('reportModal')">–û—Ç–º–µ–Ω–∞</button></div>
</div></div>

<div class="modal-overlay" id="sleepTimerModal"><div class="modal">
  <div class="modal-title">–¢–∞–π–º–µ—Ä —Å–Ω–∞</div>
  <p style="font:400 14px/20px 'Inter',sans-serif;color:var(--md-on-surface-variant);margin-bottom:16px">–ú—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è</p>
  <div id="sleepTimerOptions">
    <div class="settings-item" onclick="setSleepTimer(15)"><span class="material-symbols-rounded">timer</span><div class="settings-item-info"><div class="settings-item-title">15 –º–∏–Ω—É—Ç</div></div></div>
    <div class="settings-item" onclick="setSleepTimer(30)"><span class="material-symbols-rounded">timer</span><div class="settings-item-info"><div class="settings-item-title">30 –º–∏–Ω—É—Ç</div></div></div>
    <div class="settings-item" onclick="setSleepTimer(45)"><span class="material-symbols-rounded">timer</span><div class="settings-item-info"><div class="settings-item-title">45 –º–∏–Ω—É—Ç</div></div></div>
    <div class="settings-item" onclick="setSleepTimer(60)"><span class="material-symbols-rounded">timer</span><div class="settings-item-info"><div class="settings-item-title">1 —á–∞—Å</div></div></div>
    <div class="settings-item" onclick="setSleepTimer(0)"><span class="material-symbols-rounded">timer_off</span><div class="settings-item-info"><div class="settings-item-title">–û—Ç–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä</div></div></div>
  </div>
  <div class="modal-actions" style="margin-top:12px"><button class="btn-outlined" onclick="closeModal('sleepTimerModal')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<div class="modal-overlay" id="editTrackModal"><div class="modal">
  <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–∫</div>
  <label class="modal-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
  <input class="md-input" id="editTrackTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
  <label class="modal-label">–ñ–∞–Ω—Ä</label>
  <input class="md-input" id="editTrackGenre" placeholder="–ñ–∞–Ω—Ä">
  <label class="modal-label">–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏</label>
  <textarea class="md-input" id="editTrackLyrics" placeholder="–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏..." rows="4" style="resize:vertical"></textarea>
  <div class="modal-actions"><button class="btn-outlined" onclick="closeModal('editTrackModal')">–û—Ç–º–µ–Ω–∞</button><button class="btn-primary" onclick="saveTrackEdits()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
</div></div>

<div class="snackbar" id="snackbar"></div>
<audio id="audioPlayer" preload="auto"></audio>

<script>
const firebaseConfig={apiKey:"AIzaSyBi_ZxAPL7SOZGf-EX-mYxEuePztC4XoVc",authDomain:"musicplatforme.firebaseapp.com",databaseURL:"https://musicplatforme-default-rtdb.firebaseio.com",projectId:"musicplatforme",storageBucket:"musicplatforme.firebasestorage.app",messagingSenderId:"947754451244",appId:"1:947754451244:web:0e4bbe8403f91a57c8ec89"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* ===== STATE ===== */
let currentUser=null,allTracks={},currentTrackId=null,playlist=[],playlistIndex=-1;
let isPlaying=false,isShuffle=false,repeatMode=0;
let favorites={},subscriptions={},userPlaylists={},deleteTrackId=null;
let selectedAudioFile=null,selectedAudioDataURL=null,playerVisible=false;
let selectedCoverDataURL=null,reportTrackId=null,contextTrackId=null;
let playCountCooldowns={},listeningHistory=[],sleepTimerId=null,editTrackId=null;
let currentArtistTracks=[],currentArtistId=null,queueOpen=false,lyricsOpen=false;
const audio=document.getElementById('audioPlayer');

/* ===== GENRES ===== */
const genres=[
  {id:'all',label:'–í—Å–µ',icon:'apps'},{id:'pop',label:'–ü–æ–ø',icon:'star'},{id:'rock',label:'–†–æ–∫',icon:'electric_bolt'},
  {id:'hiphop',label:'–•–∏–ø-—Ö–æ–ø',icon:'mic'},{id:'electronic',label:'–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è',icon:'equalizer'},
  {id:'rnb',label:'R&B',icon:'nightlife'},{id:'jazz',label:'–î–∂–∞–∑',icon:'piano'},
  {id:'classical',label:'–ö–ª–∞—Å—Å–∏–∫–∞',icon:'music_note'},{id:'indie',label:'–ò–Ω–¥–∏',icon:'headphones'},
  {id:'metal',label:'–ú–µ—Ç–∞–ª',icon:'whatshot'},{id:'phonk',label:'Phonk',icon:'speed'},
  {id:'lofi',label:'Lo-Fi',icon:'self_improvement'},{id:'dnb',label:'D&B',icon:'bolt'},
  {id:'house',label:'House',icon:'house'},{id:'techno',label:'Techno',icon:'settings_suggest'},
  {id:'trap',label:'Trap',icon:'explicit'},{id:'reggaeton',label:'Reggaeton',icon:'celebration'},
  {id:'kpop',label:'K-Pop',icon:'auto_awesome'},{id:'other',label:'–î—Ä—É–≥–æ–µ',icon:'more_horiz'}
];

/* ===== EXPLICIT CHECK ===== */
const explicitWords=['fuck','shit','bitch','ass','dick','damn','bastard','crap','piss','cock','pussy','—Ö—É–π','–ø–∏–∑–¥','–±–ª—è–¥—å','–±–ª—è','—ë–±','–µ–±','—Å—É–∫','–º—É–¥–∞–∫','–º—É–¥–∏–ª','–ø–∏–¥–æ—Ä','–ø–∏–¥–∞—Ä','–∑–∞–ª—É–ø','—Ö–µ—Ä','–¥–µ—Ä—å–º','—Å—Ä–∞–Ω—å','—Å—É–∫–∞','–µ–±–∞–Ω','–µ–±–∞—Ç','—ë–±–∞–Ω','–ø–∏–∑–¥–µ—Ü','–Ω–∞—Ö—É–π','–Ω–∞—Ö–µ—Ä','–ø–æ—Ö—É–π','–æ—Ö—É–µ','–∞—Ö—É–µ','—à–ª—é—Ö','–ø—Ä–æ—Å—Ç–∏—Ç—É—Ç','—É–±–ª—é–¥–æ–∫','–≥–∞–Ω–¥–æ–Ω','–º–∞–Ω–¥–∞','–µ–±–ª–æ','—ë–±–ª','—Ö—É–µ','—Ö—É—ë','–ø–∏–∑–∂','–≤—ã–±–ª—è–¥–æ–∫','–¥–æ–ª–±–æ—ë–±','–¥–æ–ª–±–æ–µ–±','–∑–∞–µ–±','–∑–∞—ë–±','–æ—Ç—ä–µ–±','–ø–æ–¥—ä–µ–±','—É—ë–±','—É–µ–±','—Ä–∞–∑—ä–µ–±','—Ä–∞–∑—ä—ë–±','–æ–±—ä–µ–±','–æ–±—ä—ë–±','–ø–µ—Ä–µ–µ–±','–ø–µ—Ä–µ—ë–±','–≤—ã–µ–±','–≤—ã—ë–±','–≤–∑—ä–µ–±','–≤–∑—ä—ë–±','–¥–æ–µ–±','–¥–æ—ë–±','–Ω–∞–µ–±','–Ω–∞—ë–±','–ø—Ä–∏–µ–±','–ø—Ä–∏—ë–±','–ø—Ä–∏–ø–∏–∑–¥','—Ä–∞—Å–ø–∏–∑–¥','—Å–ø–∏–∑–¥','–ø–∏–∑–¥–∞—Ç','–∑–∞–ø–∏–∑–¥','–æ—Ç–ø–∏–∑–¥','–ø–æ–ø–∏–∑–¥','—Ö—É—è—Ä','—Ö—É—è—á','—Ö—É—è–∫','–ø–∏–∑–¥—é–ª','—ë–±–∞—Ä—å','–µ–±–∞—Ä—å','–º—É–¥–æ–∑–≤–æ–Ω','fucker','motherfuck','asshole','bullshit','nigger','nigga','whore','slut','cunt','twat','wanker','jackass'];
function checkExplicit(t){if(!t)return false;const l=t.toLowerCase().replace(/[^a-z–∞-—è—ë–π0-9]/gi,' ');for(const w of explicitWords)if(l.includes(w.toLowerCase()))return true;return false}

/* ===== GENRE CUSTOM ===== */
document.getElementById('uploadGenre').addEventListener('change',function(){
  document.getElementById('uploadCustomGenre').style.display=this.value==='custom'?'block':'none';
});

/* ===== COVER HANDLING ===== */
function handleCoverSelect(e){
  const f=e.target.files[0];if(!f)return;
  if(!f.type.startsWith('image/')){showSnackbar('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');return}
  if(f.size>5*1024*1024){showSnackbar('–û–±–ª–æ–∂–∫–∞ –º–∞–∫—Å. 5 –ú–ë');return}
  const r=new FileReader();
  r.onload=ev=>{selectedCoverDataURL=ev.target.result;document.getElementById('coverUploadZone').innerHTML='<img src="'+selectedCoverDataURL+'" alt="">';document.getElementById('uploadCover').value=''};
  r.readAsDataURL(f);
}

function extractEmbeddedCover(file){
  return new Promise(resolve=>{
    const reader=new FileReader();
    reader.onload=function(e){
      const buf=new Uint8Array(e.target.result);
      if(buf[0]===0x49&&buf[1]===0x44&&buf[2]===0x33){
        const size=((buf[6]&0x7f)<<21)|((buf[7]&0x7f)<<14)|((buf[8]&0x7f)<<7)|(buf[9]&0x7f);
        let pos=10;const version=buf[3];
        if(version>=3){
          while(pos<size+10){
            const frameId=String.fromCharCode(buf[pos],buf[pos+1],buf[pos+2],buf[pos+3]);
            let frameSize;
            if(version===4){frameSize=((buf[pos+4]&0x7f)<<21)|((buf[pos+5]&0x7f)<<14)|((buf[pos+6]&0x7f)<<7)|(buf[pos+7]&0x7f)}
            else{frameSize=(buf[pos+4]<<24)|(buf[pos+5]<<16)|(buf[pos+6]<<8)|buf[pos+7]}
            if(frameSize<=0||pos+10+frameSize>buf.length)break;
            if(frameId==='APIC'){
              const data=buf.slice(pos+10,pos+10+frameSize);
              let i=1;let mime='';
              while(i<data.length&&data[i]!==0){mime+=String.fromCharCode(data[i]);i++}
              i++;i++;while(i<data.length&&data[i]!==0)i++;i++;
              if(!mime||mime==='image/jpeg')mime='image/jpeg';
              else if(mime==='image/png')mime='image/png';
              const imgData=data.slice(i);let binary='';
              for(let j=0;j<imgData.length;j++)binary+=String.fromCharCode(imgData[j]);
              resolve('data:'+mime+';base64,'+btoa(binary));return;
            }
            pos+=10+frameSize;
          }
        }
      }
      resolve(null);
    };
    reader.onerror=()=>resolve(null);
    reader.readAsArrayBuffer(file);
  });
}

/* ===== AUTH ===== */
function hashPassword(p){return crypto.subtle.digest('SHA-256',new TextEncoder().encode(p)).then(b=>Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join(''))}
function switchAuthTab(t){
  document.getElementById('tabLogin').classList.toggle('active',t==='login');
  document.getElementById('tabRegister').classList.toggle('active',t==='register');
  document.getElementById('loginForm').style.display=t==='login'?'':'none';
  document.getElementById('registerForm').style.display=t==='register'?'':'none';
  document.getElementById('loginError').textContent='';document.getElementById('regError').textContent='';
}
function togglePasswordVis(id,btn){const i=document.getElementById(id),ic=btn.querySelector('.material-symbols-rounded');if(i.type==='password'){i.type='text';ic.textContent='visibility'}else{i.type='password';ic.textContent='visibility_off'}}

async function doRegister(){
  const u=document.getElementById('regUsername').value.trim().toLowerCase(),e=document.getElementById('regEmail').value.trim().toLowerCase(),d=document.getElementById('regDisplayName').value.trim(),p=document.getElementById('regPassword').value,p2=document.getElementById('regPassword2').value,err=document.getElementById('regError');
  err.textContent='';
  if(!u||u.length<3){err.textContent='–õ–æ–≥–∏–Ω –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';return}
  if(!/^[a-zA-Z0-9_]+$/.test(u)){err.textContent='–õ–æ–≥–∏–Ω: –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, _';return}
  if(!e||!e.includes('@')){err.textContent='–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Email';return}
  if(!d){err.textContent='–í–≤–µ–¥–∏—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è';return}
  if(p.length<6){err.textContent='–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';return}
  if(p!==p2){err.textContent='–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';return}
  err.innerHTML='<div class="loading-spinner" style="width:16px;height:16px;margin:0;border-width:2px;display:inline-block;vertical-align:middle"></div>';
  try{
    const us=await db.ref('usernames/'+u).once('value');if(us.exists()){err.textContent='–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç';return}
    const ek=e.replace(/\./g,','),es=await db.ref('emails/'+ek).once('value');if(es.exists()){err.textContent='Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';return}
    const ph=await hashPassword(p),uid='u_'+Date.now()+'_'+Math.random().toString(36).substr(2,8);
    const ud={uid,username:u,email:e,displayName:d,photo:'',bio:'',passwordHash:ph,authMethod:'email',createdAt:Date.now()};
    await db.ref('users/'+uid).set(ud);await db.ref('usernames/'+u).set(uid);await db.ref('emails/'+ek).set(uid);
    loginUser(ud);showSnackbar('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, '+d+'!');
  }catch(x){err.textContent='–û—à–∏–±–∫–∞: '+x.message}
}

async function doLogin(){
  const id=document.getElementById('loginIdentity').value.trim().toLowerCase(),p=document.getElementById('loginPassword').value,err=document.getElementById('loginError');
  err.textContent='';if(!id){err.textContent='–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏–ª–∏ Email';return}if(!p){err.textContent='–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';return}
  err.innerHTML='<div class="loading-spinner" style="width:16px;height:16px;margin:0;border-width:2px;display:inline-block;vertical-align:middle"></div>';
  try{
    let uid=null;
    if(id.includes('@')){const s=await db.ref('emails/'+id.replace(/\./g,',')).once('value');uid=s.val()}
    else{const s=await db.ref('usernames/'+id).once('value');uid=s.val()}
    if(!uid){err.textContent='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';return}
    const us=await db.ref('users/'+uid).once('value'),ud=us.val();
    if(!ud){err.textContent='–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';return}
    const ph=await hashPassword(p);if(ud.passwordHash!==ph){err.textContent='–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';return}
    loginUser(ud);showSnackbar('–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, '+ud.displayName+'!');
  }catch(x){err.textContent='–û—à–∏–±–∫–∞: '+x.message}
}

function loginUser(ud){
  currentUser={uid:ud.uid,username:ud.username||'',email:ud.email||'',displayName:ud.displayName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',photo:ud.photo||'',bio:ud.bio||'',authMethod:ud.authMethod||'email'};
  localStorage.setItem('mp_user',JSON.stringify(currentUser));updateAuthUI();loadUserData();
}
function signOutUser(){currentUser=null;localStorage.removeItem('mp_user');favorites={};subscriptions={};userPlaylists={};listeningHistory=[];updateAuthUI();showSnackbar('–í—ã –≤—ã—à–ª–∏');navigate('home')}
function restoreSession(){const s=localStorage.getItem('mp_user');if(s){try{currentUser=JSON.parse(s);updateAuthUI();loadUserData()}catch(e){localStorage.removeItem('mp_user')}}}

/* ===== TELEGRAM AUTH ===== */
window.onTelegramAuth=async function(tg){
  if(!tg||!tg.id){showSnackbar('–û—à–∏–±–∫–∞ Telegram');return}
  const uid='tg_'+tg.id;const s=await db.ref('users/'+uid).once('value');let ud=s.val();
  if(!ud){const dn=(tg.first_name||'')+(tg.last_name?' '+tg.last_name:''),un=tg.username||('tg'+tg.id);
    ud={uid,username:un,email:'',displayName:dn||'Telegram User',photo:tg.photo_url||'',bio:'',authMethod:'telegram',telegramId:tg.id,createdAt:Date.now()};
    await db.ref('users/'+uid).set(ud);if(tg.username)await db.ref('usernames/'+tg.username.toLowerCase()).set(uid)}
  loginUser(ud);showSnackbar('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!');
};
window.onTelegramLink=async function(tg){
  if(!currentUser||!tg)return;
  await db.ref('users/'+currentUser.uid+'/telegramId').set(tg.id);
  await db.ref('users/'+currentUser.uid+'/telegramUsername').set(tg.username||'');
  if(tg.photo_url&&!currentUser.photo){await db.ref('users/'+currentUser.uid+'/photo').set(tg.photo_url);currentUser.photo=tg.photo_url;localStorage.setItem('mp_user',JSON.stringify(currentUser));updateAuthUI()}
  closeModal('linkTelegramModal');showSnackbar('Telegram –ø—Ä–∏–≤—è–∑–∞–Ω!');openSettings();
};
function openTelegramLogin(){openTgPopup('onTelegramAuth')}
function linkTelegram(){openTgPopup('onTelegramLink')}
function openTgPopup(cbName){
  const w=550,h=470,l=(screen.width-w)/2,t=(screen.height-h)/2;
  const p=window.open('','TelegramLogin','width='+w+',height='+h+',left='+l+',top='+t+',resizable=yes');
  if(!p){showSnackbar('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞');return}
  p.document.write('<!DOCTYPE html><html><head><title>Telegram</title><style>body{font-family:Inter,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;background:#F3EDF7;color:#1D1B20}h2{margin-bottom:24px;font-weight:600}</style></head><body><h2>–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</h2><div id="w"></div><script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="VriskasRobot" data-size="large" data-radius="20" data-onauth="onTgAuth(user)" data-request-access="write"><\/script><script>function onTgAuth(u){if(window.opener&&window.opener.'+cbName+'){window.opener.'+cbName+'(u);window.close()}}<\/script></body></html>');
  p.document.close();
}

/* ===== AUTH UI ===== */
function updateAuthUI(){
  const ai=document.getElementById('avatarIcon'),am=document.getElementById('avatarImg');
  if(currentUser){
    if(currentUser.photo){ai.style.display='none';am.style.display='block';am.src=currentUser.photo}else{ai.style.display='';am.style.display='none'}
    document.getElementById('uploadAuthMsg').style.display='none';document.getElementById('uploadForm').style.display='block';
    document.getElementById('profileAuthMsg').style.display='none';document.getElementById('profileContent').style.display='block';
    document.getElementById('profileName').textContent=currentUser.displayName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('profileLogin').textContent='@'+(currentUser.username||'user');
    const pa=document.getElementById('profileAvatar');
    pa.innerHTML=currentUser.photo?'<img src="'+currentUser.photo+'" alt="">':'<span class="material-symbols-rounded" style="font-size:48px;color:var(--md-primary)">person</span>';
  }else{
    ai.style.display='';am.style.display='none';
    document.getElementById('uploadAuthMsg').style.display='block';document.getElementById('uploadForm').style.display='none';
    document.getElementById('profileAuthMsg').style.display='block';document.getElementById('profileContent').style.display='none';
  }
  updateUserMenu();
}

function updateUserMenu(){
  const c=document.getElementById('userMenuContent');
  if(currentUser){
    c.innerHTML='<div style="padding:16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--md-outline-variant)"><div style="width:40px;height:40px;border-radius:50%;overflow:hidden;background:var(--md-primary-container);display:flex;align-items:center;justify-content:center;flex-shrink:0">'+(currentUser.photo?'<img src="'+currentUser.photo+'" style="width:100%;height:100%;object-fit:cover">':'<span class="material-symbols-rounded">person</span>')+'</div><div style="min-width:0"><div style="font:500 14px/20px \'Inter\',sans-serif;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+esc(currentUser.displayName)+'</div><div style="font:400 12px/16px \'Inter\',sans-serif;color:var(--md-on-surface-variant)">@'+esc(currentUser.username)+'</div></div></div>'+
    '<div class="user-menu-item" onclick="navigate(\'profile\');closeUserMenu()"><span class="material-symbols-rounded">person</span> –ü—Ä–æ—Ñ–∏–ª—å</div>'+
    '<div class="user-menu-item" onclick="navigate(\'upload\');closeUserMenu()"><span class="material-symbols-rounded">upload</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å</div>'+
    '<div class="user-menu-item" onclick="navigate(\'history\');closeUserMenu()"><span class="material-symbols-rounded">history</span> –ò—Å—Ç–æ—Ä–∏—è</div>'+
    '<div class="user-menu-item" onclick="openSleepTimer();closeUserMenu()"><span class="material-symbols-rounded">bedtime</span> –¢–∞–π–º–µ—Ä —Å–Ω–∞</div>'+
    '<div class="user-menu-item" onclick="openSettings();closeUserMenu()"><span class="material-symbols-rounded">settings</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>'+
    '<div class="user-menu-item" onclick="signOutUser();closeUserMenu()"><span class="material-symbols-rounded">logout</span> –í—ã–π—Ç–∏</div>';
  }else{
    c.innerHTML='<div class="user-menu-item" onclick="navigate(\'profile\');closeUserMenu()"><span class="material-symbols-rounded">login</span> –í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>';
  }
}
function toggleUserMenu(){document.getElementById('userMenu').classList.toggle('open')}
function closeUserMenu(){document.getElementById('userMenu').classList.remove('open')}
document.addEventListener('click',e=>{if(!e.target.closest('#userMenu')&&!e.target.closest('#userAvatarBtn'))closeUserMenu()});

/* ===== SETTINGS ===== */
function openSettings(){
  if(!currentUser){showSnackbar('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');return}
  db.ref('users/'+currentUser.uid).once('value').then(s=>{
    const u=s.val()||{},hasTg=!!u.telegramId,hasEmail=!!u.email&&!!u.passwordHash;
    document.getElementById('settingsContent').innerHTML=
      '<div class="settings-item" onclick="openEditProfile()"><span class="material-symbols-rounded">edit</span><div class="settings-item-info"><div class="settings-item-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div><div class="settings-item-sub">–ò–º—è, –∞–≤–∞—Ç–∞—Ä, –±–∏–æ</div></div><span class="material-symbols-rounded" style="color:var(--md-outline)">chevron_right</span></div>'+
      '<div class="settings-item" onclick="'+(hasEmail?'showSnackbar(\'Email —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω\')':'openLinkEmail()')+'" ><span class="material-symbols-rounded">mail</span><div class="settings-item-info"><div class="settings-item-title">Email –∏ –ø–∞—Ä–æ–ª—å</div><div class="settings-item-sub">'+(hasEmail?(u.email||'–ü—Ä–∏–≤—è–∑–∞–Ω'):'–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω')+'</div></div>'+(hasEmail?'<span class="material-symbols-rounded" style="color:var(--md-primary)">check_circle</span>':'<span class="material-symbols-rounded" style="color:var(--md-outline)">chevron_right</span>')+'</div>'+
      '<div class="settings-item" onclick="'+(hasTg?'showSnackbar(\'Telegram —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω\')':'openLinkTelegram()')+'" ><span class="material-symbols-rounded">send</span><div class="settings-item-info"><div class="settings-item-title">Telegram</div><div class="settings-item-sub">'+(hasTg?('@'+(u.telegramUsername||'–ü—Ä–∏–≤—è–∑–∞–Ω')):'–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω')+'</div></div>'+(hasTg?'<span class="material-symbols-rounded" style="color:var(--md-primary)">check_circle</span>':'<span class="material-symbols-rounded" style="color:var(--md-outline)">chevron_right</span>')+'</div>'+
      '<div style="margin:16px 0;height:1px;background:var(--md-outline-variant)"></div>'+
      '<div class="settings-item" onclick="toggleTheme();openSettings()"><span class="material-symbols-rounded">'+((document.body.getAttribute('data-theme')==='dark')?'light_mode':'dark_mode')+'</span><div class="settings-item-info"><div class="settings-item-title">–¢–µ–º–∞</div><div class="settings-item-sub">'+((document.body.getAttribute('data-theme')==='dark')?'–¢—ë–º–Ω–∞—è':'–°–≤–µ—Ç–ª–∞—è')+'</div></div></div>'+
      '<div class="settings-item" onclick="openSleepTimer()"><span class="material-symbols-rounded">bedtime</span><div class="settings-item-info"><div class="settings-item-title">–¢–∞–π–º–µ—Ä —Å–Ω–∞</div><div class="settings-item-sub">'+(sleepTimerId?'–ê–∫—Ç–∏–≤–µ–Ω':'–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')+'</div></div></div>'+
      '<div style="margin:16px 0;height:1px;background:var(--md-outline-variant)"></div>'+
      '<div class="settings-item" onclick="signOutUser();closeModal(\'settingsModal\')"><span class="material-symbols-rounded" style="color:var(--md-error)">logout</span><div class="settings-item-info"><div class="settings-item-title" style="color:var(--md-error)">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</div></div></div>';
    document.getElementById('settingsModal').classList.add('open');
  });
}

function openEditProfile(){
  closeModal('settingsModal');
  document.getElementById('editDisplayName').value=currentUser.displayName||'';
  document.getElementById('editAvatarUrl').value=currentUser.photo||'';
  document.getElementById('editBio').value=currentUser.bio||'';
  const zone=document.getElementById('editAvatarZone');
  zone.innerHTML=currentUser.photo?'<img src="'+currentUser.photo+'" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%">':'<span class="material-symbols-rounded">add_a_photo</span>';
  document.getElementById('editProfileModal').classList.add('open');
}
function handleAvatarSelect(e){
  const f=e.target.files[0];if(!f||!f.type.startsWith('image/'))return;
  if(f.size>2*1024*1024){showSnackbar('–ê–≤–∞—Ç–∞—Ä –º–∞–∫—Å. 2 –ú–ë');return}
  const r=new FileReader();r.onload=ev=>{document.getElementById('editAvatarZone').innerHTML='<img src="'+ev.target.result+'" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%">';document.getElementById('editAvatarUrl').value=ev.target.result};r.readAsDataURL(f);
}
async function saveProfileEdits(){
  if(!currentUser)return;
  const dn=document.getElementById('editDisplayName').value.trim(),photo=document.getElementById('editAvatarUrl').value.trim(),bio=document.getElementById('editBio').value.trim();
  if(!dn){showSnackbar('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');return}
  await db.ref('users/'+currentUser.uid).update({displayName:dn,photo,bio});
  const snap=await db.ref('tracks').orderByChild('artistId').equalTo(currentUser.uid).once('value');
  const tracks=snap.val()||{},u={};
  Object.keys(tracks).forEach(tid=>{u[tid+'/artistName']=dn;u[tid+'/artistPhoto']=photo});
  if(Object.keys(u).length)await db.ref('tracks').update(u);
  currentUser.displayName=dn;currentUser.photo=photo;currentUser.bio=bio;
  localStorage.setItem('mp_user',JSON.stringify(currentUser));
  updateAuthUI();closeModal('editProfileModal');showSnackbar('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω');
}
function openLinkTelegram(){closeModal('settingsModal');document.getElementById('linkTelegramModal').classList.add('open')}
function openLinkEmail(){closeModal('settingsModal');document.getElementById('linkEmailModal').classList.add('open');document.getElementById('linkEmailError').textContent=''}
async function saveLinkEmail(){
  if(!currentUser)return;
  const e=document.getElementById('linkEmail').value.trim().toLowerCase(),p=document.getElementById('linkPassword').value,err=document.getElementById('linkEmailError');
  if(!e||!e.includes('@')){err.textContent='–í–≤–µ–¥–∏—Ç–µ Email';return}
  if(p.length<6){err.textContent='–ü–∞—Ä–æ–ª—å –º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤';return}
  const ek=e.replace(/\./g,','),es=await db.ref('emails/'+ek).once('value');
  if(es.exists()){err.textContent='Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';return}
  const ph=await hashPassword(p);
  await db.ref('users/'+currentUser.uid+'/email').set(e);await db.ref('users/'+currentUser.uid+'/passwordHash').set(ph);await db.ref('emails/'+ek).set(currentUser.uid);
  currentUser.email=e;localStorage.setItem('mp_user',JSON.stringify(currentUser));
  closeModal('linkEmailModal');showSnackbar('Email –ø—Ä–∏–≤—è–∑–∞–Ω!');openSettings();
}

/* ===== SLEEP TIMER ===== */
function openSleepTimer(){document.getElementById('sleepTimerModal').classList.add('open')}
function setSleepTimer(mins){
  closeModal('sleepTimerModal');
  if(sleepTimerId){clearTimeout(sleepTimerId);sleepTimerId=null}
  if(mins===0){showSnackbar('–¢–∞–π–º–µ—Ä —Å–Ω–∞ –æ—Ç–∫–ª—é—á—ë–Ω');return}
  sleepTimerId=setTimeout(()=>{if(isPlaying)togglePlay();sleepTimerId=null;showSnackbar('–¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–ª üí§')},mins*60*1000);
  showSnackbar('–¢–∞–π–º–µ—Ä —Å–Ω–∞: '+mins+' –º–∏–Ω');
}

/* ===== USER DATA ===== */
function loadUserData(){
  if(!currentUser)return;const uid=currentUser.uid;
  db.ref('favorites/'+uid).on('value',s=>{favorites=s.val()||{};renderFavorites();updateFsLike()});
  db.ref('subscriptions/'+uid).on('value',s=>{subscriptions=s.val()||{};renderSubscriptions()});
  db.ref('playlists/'+uid).on('value',s=>{userPlaylists=s.val()||{};renderPlaylists()});
  db.ref('history/'+uid).orderByChild('time').limitToLast(100).on('value',s=>{
    listeningHistory=[];s.forEach(c=>{listeningHistory.unshift({id:c.key,...c.val()})});renderHistory();
  });
  loadMyTracks();loadProfileStats();
}
function loadMyTracks(){
  if(!currentUser)return;
  db.ref('tracks').orderByChild('artistId').equalTo(currentUser.uid).on('value',snap=>{
    const tracks=snap.val()||{},arr=Object.entries(tracks).sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0));
    ['myTracks','profileTrackList'].forEach(elId=>{
      const el=document.getElementById(elId);if(!el)return;
      if(arr.length===0)el.innerHTML='<div class="empty-state"><span class="material-symbols-rounded">library_music</span><h3>–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤</h3></div>';
      else el.innerHTML=arr.map(([id,t],i)=>renderTrackItem(id,t,i+1,true)).join('');
    });
    document.getElementById('profileTracks').textContent=arr.length;
    // Stats grid
    const totalPlays=arr.reduce((s,[id,t])=>s+(t.plays||0),0);
    const totalLikes=arr.reduce((s,[id,t])=>s+(t.likes||0),0);
    document.getElementById('profileStatsGrid').innerHTML=
      '<div class="stat-card"><div class="stat-value">'+arr.length+'</div><div class="stat-label">–¢—Ä–µ–∫–æ–≤</div></div>'+
      '<div class="stat-card"><div class="stat-value">'+formatPlays(totalPlays)+'</div><div class="stat-label">–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π</div></div>'+
      '<div class="stat-card"><div class="stat-value">'+totalLikes+'</div><div class="stat-label">–õ–∞–π–∫–æ–≤</div></div>'+
      '<div class="stat-card"><div class="stat-value">'+Object.keys(favorites).length+'</div><div class="stat-label">–í –ª—é–±–∏–º–æ–º</div></div>';
  });
}
function loadProfileStats(){if(!currentUser)return;db.ref('subscribers/'+currentUser.uid).on('value',s=>{document.getElementById('profileSubs').textContent=Object.keys(s.val()||{}).length})}

/* ===== TRACKS LISTENER ===== */
db.ref('tracks').on('value',snap=>{
  allTracks=snap.val()||{};renderHome();renderExplore();renderCharts();renderNewReleases();
  if(document.getElementById('page-search').classList.contains('active'))handleSearch(document.getElementById('searchInput').value);
});

/* ===== RENDER TRACK ITEM ===== */
function renderTrackItem(id,track,num,showDel){
  const isExp=track.explicit,isFav=favorites[id],isNP=currentTrackId===id,dur=track.duration?formatTime(track.duration):'‚Äî';
  const plays=track.plays||0;
  return '<div class="track-item '+(isNP?'playing':'')+'" data-id="'+id+'" onclick="playTrackById(\''+id+'\')">'+
    '<div class="track-num">'+(isNP?'<span class="material-symbols-rounded filled" style="color:var(--md-primary);font-size:18px">equalizer</span>':num)+'</div>'+
    '<div class="track-thumb">'+(track.cover?'<img src="'+track.cover+'" alt="" loading="lazy" onerror="this.style.display=\'none\'">':'')+'<span class="material-symbols-rounded" style="'+(track.cover?'display:none':'')+'">music_note</span><div class="play-overlay"><span class="material-symbols-rounded" style="color:white;font-size:24px">play_arrow</span></div></div>'+
    '<div class="track-info"><div class="track-title-row"><span class="track-name">'+esc(track.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')+'</span>'+(isExp?'<span class="explicit-badge" title="Explicit">!</span>':'')+'</div>'+
    '<div class="track-artist" onclick="event.stopPropagation();viewArtist(\''+track.artistId+'\')">'+esc(track.artistName||'–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')+'</div></div>'+
    '<div class="track-plays"><span class="material-symbols-rounded">play_arrow</span>'+formatPlays(plays)+'</div>'+
    '<div class="track-actions">'+
    '<button class="btn-icon '+(isFav?'active':'')+'" onclick="event.stopPropagation();toggleFavorite(\''+id+'\')" title="–ù—Ä–∞–≤–∏—Ç—Å—è"><span class="material-symbols-rounded '+(isFav?'filled':'')+'">favorite</span></button>'+
    '<button class="btn-icon" onclick="event.stopPropagation();openTrackContextMenu(event,\''+id+'\')" title="–ï—â—ë"><span class="material-symbols-rounded">more_vert</span></button>'+
    (showDel?'<button class="btn-icon" onclick="event.stopPropagation();deleteTrack(\''+id+'\')" title="–£–¥–∞–ª–∏—Ç—å"><span class="material-symbols-rounded">delete</span></button>':'')+
    '</div><div class="track-duration">'+dur+'</div></div>';
}

function formatPlays(n){if(n>=1000000)return(n/1000000).toFixed(1)+'M';if(n>=1000)return(n/1000).toFixed(1)+'K';return n.toString()}

/* ===== CONTEXT MENU ===== */
function openTrackContextMenu(e,tid){
  e.stopPropagation();
  document.querySelectorAll('.track-context-menu').forEach(m=>m.remove());
  contextTrackId=tid;const track=allTracks[tid];if(!track)return;
  const isFav=favorites[tid],isOwner=currentUser&&track.artistId===currentUser.uid;
  const menu=document.createElement('div');menu.className='track-context-menu';
  let items='';
  items+='<div class="track-context-item" onclick="togglePlayNext(\''+tid+'\');this.parentElement.remove()"><span class="material-symbols-rounded">queue_play_next</span>–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å–ª–µ–¥—É—é—â–∏–º</div>';
  items+='<div class="track-context-item" onclick="addToQueue(\''+tid+'\');this.parentElement.remove()"><span class="material-symbols-rounded">add_to_queue</span>–í –æ—á–µ—Ä–µ–¥—å</div>';
  if(currentUser){
    items+='<div class="track-context-item" onclick="toggleFavorite(\''+tid+'\');this.parentElement.remove()"><span class="material-symbols-rounded">'+(isFav?'heart_broken':'favorite')+'</span>'+(isFav?'–£–±—Ä–∞—Ç—å –∏–∑ –ª—é–±–∏–º–æ–≥–æ':'–í –ª—é–±–∏–º–æ–µ')+'</div>';
    items+='<div class="track-context-item" onclick="openAddToPlaylist(\''+tid+'\');this.parentElement.remove()"><span class="material-symbols-rounded">playlist_add</span>–í –ø–ª–µ–π–ª–∏—Å—Ç</div>';
  }
  items+='<div class="track-context-item" onclick="viewArtist(\''+track.artistId+'\');this.parentElement.remove()"><span class="material-symbols-rounded">person</span>–ü—Ä–æ—Ñ–∏–ª—å –∞—Ä—Ç–∏—Å—Ç–∞</div>';
  items+='<div class="track-context-item" onclick="shareTrackById(\''+tid+'\');this.parentElement.remove()"><span class="material-symbols-rounded">share</span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</div>';
  if(isOwner){
    items+='<div class="track-context-item" onclick="openEditTrack(\''+tid+'\');this.parentElement.remove()"><span class="material-symbols-rounded">edit</span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>';
    items+='<div class="track-context-item danger" onclick="deleteTrack(\''+tid+'\');this.parentElement.remove()"><span class="material-symbols-rounded">delete</span>–£–¥–∞–ª–∏—Ç—å</div>';
  }else if(currentUser){
    items+='<div class="track-context-item danger" onclick="openReport(\''+tid+'\');this.parentElement.remove()"><span class="material-symbols-rounded">flag</span>–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</div>';
  }
  menu.innerHTML=items;
  menu.style.top=Math.min(e.clientY,window.innerHeight-300)+'px';
  menu.style.right=(window.innerWidth-e.clientX)+'px';
  document.body.appendChild(menu);
  requestAnimationFrame(()=>{const r=menu.getBoundingClientRect();if(r.bottom>window.innerHeight)menu.style.top=(window.innerHeight-r.height-8)+'px';if(r.right>window.innerWidth)menu.style.right='8px'});
  setTimeout(()=>{document.addEventListener('click',()=>menu.remove(),{once:true})},10);
}

function togglePlayNext(tid){if(!playlist.length){playlist=[tid];playlistIndex=0;return}playlist.splice(playlistIndex+1,0,tid);showSnackbar('–ë—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–∏–º')}
function addToQueue(tid){if(!playlist.length){playlist=[tid];playlistIndex=0;return}if(!playlist.includes(tid))playlist.push(tid);showSnackbar('–î–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å');renderQueue()}
function openAddToPlaylist(tid){
  contextTrackId=tid;const list=document.getElementById('addToPlaylistList');
  const entries=Object.entries(userPlaylists);
  if(entries.length===0){list.innerHTML='<div class="empty-state" style="padding:20px"><span class="material-symbols-rounded">queue_music</span><h3>–ù–µ—Ç –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤</h3><p>–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–ª–µ–π–ª–∏—Å—Ç</p></div>'}
  else{list.innerHTML=entries.map(([id,pl])=>'<div class="settings-item" onclick="addTrackToPlaylist(\''+id+'\')"><span class="material-symbols-rounded">queue_music</span><div class="settings-item-info"><div class="settings-item-title">'+esc(pl.name)+'</div><div class="settings-item-sub">'+(pl.tracks?Object.keys(pl.tracks).length:0)+' —Ç—Ä–µ–∫–æ–≤</div></div></div>').join('')}
  document.getElementById('addToPlaylistModal').classList.add('open');
}
function addTrackToPlaylist(plId){if(!currentUser||!contextTrackId)return;db.ref('playlists/'+currentUser.uid+'/'+plId+'/tracks/'+contextTrackId).set(true);closeModal('addToPlaylistModal');showSnackbar('–î–æ–±–∞–≤–ª–µ–Ω –≤ –ø–ª–µ–π–ª–∏—Å—Ç')}
function addToPlaylistPrompt(){if(!currentUser){showSnackbar('–í–æ–π–¥–∏—Ç–µ');return}if(!currentTrackId)return;openAddToPlaylist(currentTrackId)}

function openReport(tid){reportTrackId=tid;document.getElementById('reportModal').classList.add('open')}
function submitReport(reason){if(!currentUser||!reportTrackId)return;db.ref('reports').push({trackId:reportTrackId,userId:currentUser.uid,reason,timestamp:Date.now()});closeModal('reportModal');showSnackbar('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');reportTrackId=null}

function openEditTrack(tid){
  editTrackId=tid;const t=allTracks[tid];if(!t)return;
  document.getElementById('editTrackTitle').value=t.title||'';
  document.getElementById('editTrackGenre').value=t.genre||'';
  document.getElementById('editTrackLyrics').value=t.lyrics||'';
  document.getElementById('editTrackModal').classList.add('open');
}
function saveTrackEdits(){
  if(!editTrackId||!currentUser)return;
  const title=document.getElementById('editTrackTitle').value.trim(),genre=document.getElementById('editTrackGenre').value.trim(),lyrics=document.getElementById('editTrackLyrics').value.trim();
  if(!title){showSnackbar('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return}
  const isExp=checkExplicit(title)||checkExplicit(lyrics);
  db.ref('tracks/'+editTrackId).update({title,genre,lyrics,explicit:isExp});
  closeModal('editTrackModal');showSnackbar('–¢—Ä–µ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω');editTrackId=null;
}

function shareTrackById(tid){const t=allTracks[tid];if(!t)return;if(navigator.share){navigator.share({title:t.title,text:t.title+' ‚Äî '+t.artistName,url:location.href}).catch(()=>{})}else{navigator.clipboard.writeText(t.title+' ‚Äî '+t.artistName+' | MusicPlatforme').then(()=>showSnackbar('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'))}}
function showContextMenuForCurrent(e){if(currentTrackId)openTrackContextMenu(e,currentTrackId)}

/* ===== RENDER PAGES ===== */
function renderHome(){
  const entries=Object.entries(allTracks);
  const sorted=[...entries].sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0));
  document.getElementById('homeNewTracks').innerHTML=sorted.length===0?'<div class="empty-state"><span class="material-symbols-rounded">library_music</span><h3>–ü–æ–∫–∞ –Ω–µ—Ç —Ç—Ä–µ–∫–æ–≤</h3><p>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p></div>':sorted.slice(0,10).map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('');
  const popular=[...entries].sort((a,b)=>(b[1].plays||0)-(a[1].plays||0)).slice(0,8);
  document.getElementById('homePopular').innerHTML=popular.length===0?'':popular.map(([id,t])=>'<div class="md-card" onclick="playTrackById(\''+id+'\')"><div class="card-img">'+(t.cover?'<img src="'+t.cover+'" alt="" loading="lazy">':'<span class="material-symbols-rounded">music_note</span>')+'<div class="card-play-fab"><span class="material-symbols-rounded filled">play_arrow</span></div></div><div class="card-body"><div class="card-title" style="display:flex;align-items:center;gap:4px">'+esc(t.title||'')+(t.explicit?'<span class="explicit-badge" style="font-size:10px;width:16px;height:16px">!</span>':'')+'</div><div class="card-sub">'+esc(t.artistName||'')+'</div><div class="card-sub" style="display:flex;align-items:center;gap:4px;margin-top:2px"><span class="material-symbols-rounded" style="font-size:14px">play_arrow</span>'+formatPlays(t.plays||0)+'</div></div></div>').join('');
  const am={};entries.forEach(([id,t])=>{if(t.artistId&&!am[t.artistId])am[t.artistId]={name:t.artistName,photo:t.artistPhoto||'',id:t.artistId}});
  document.getElementById('homeArtists').innerHTML=Object.values(am).slice(0,12).map(a=>'<div class="artist-card" onclick="viewArtist(\''+a.id+'\')"><div class="artist-img">'+(a.photo?'<img src="'+a.photo+'" alt="" loading="lazy">':'<span class="material-symbols-rounded" style="font-size:40px;color:var(--md-outline)">person</span>')+'</div><div class="card-title" style="font-size:13px">'+esc(a.name||'–ê—Ä—Ç–∏—Å—Ç')+'</div></div>').join('');
}

let currentGenre='all';
function renderExplore(){
  document.getElementById('genrePills').innerHTML=genres.map(g=>'<div class="chip '+(currentGenre===g.id?'active':'')+'" onclick="filterGenre(\''+g.id+'\')"><span class="material-symbols-rounded" style="font-size:16px">'+g.icon+'</span> '+g.label+'</div>').join('');
  const entries=Object.entries(allTracks);
  let filtered=currentGenre==='all'?entries:entries.filter(([id,t])=>t.genre===currentGenre);
  filtered.sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0));
  const gl=genres.find(g=>g.id===currentGenre);
  document.getElementById('exploreTitle').textContent=currentGenre==='all'?'–í—Å–µ —Ç—Ä–µ–∫–∏':(gl?gl.label:'–¢—Ä–µ–∫–∏');
  document.getElementById('exploreTracks').innerHTML=filtered.length===0?'<div class="empty-state"><span class="material-symbols-rounded">library_music</span><h3>–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤</h3></div>':filtered.map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('');
}
function filterGenre(g){currentGenre=g;renderExplore()}

function renderCharts(){
  const entries=Object.entries(allTracks).sort((a,b)=>(b[1].plays||0)-(a[1].plays||0)).slice(0,50);
  document.getElementById('chartsTracks').innerHTML=entries.length===0?'<div class="empty-state"><span class="material-symbols-rounded">trending_up</span><h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3></div>':entries.map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('');
}

function renderNewReleases(){
  const weekAgo=Date.now()-7*24*60*60*1000;
  const entries=Object.entries(allTracks).filter(([id,t])=>(t.timestamp||0)>weekAgo).sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0));
  document.getElementById('newReleasesTracks').innerHTML=entries.length===0?'<div class="empty-state"><span class="material-symbols-rounded">new_releases</span><h3>–ù–µ—Ç –Ω–æ–≤–∏–Ω–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é</h3></div>':entries.map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('');
}

function renderHistory(){
  const el=document.getElementById('historyTracks'),c=document.getElementById('historyContent');
  if(!listeningHistory.length){c.style.display='';el.innerHTML='';return}
  c.style.display='none';
  el.innerHTML=listeningHistory.filter(h=>allTracks[h.trackId]).map((h,i)=>{const t=allTracks[h.trackId];return renderTrackItem(h.trackId,t,i+1)}).join('');
}
function clearHistory(){if(!currentUser)return;db.ref('history/'+currentUser.uid).remove();listeningHistory=[];renderHistory();showSnackbar('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞')}

/* ===== SEARCH ===== */
function handleSearch(q){
  if(!q||q.trim().length<2){if(document.getElementById('page-search').classList.contains('active'))navigate('home');return}
  navigate('search');const query=q.toLowerCase().trim();
  const trackResults=Object.entries(allTracks).filter(([id,t])=>(t.title||'').toLowerCase().includes(query)||(t.artistName||'').toLowerCase().includes(query)||(t.genre||'').toLowerCase().includes(query));
  const artistMap={};
  Object.entries(allTracks).forEach(([id,t])=>{if(t.artistId){if(!artistMap[t.artistId])artistMap[t.artistId]={name:t.artistName||'',photo:t.artistPhoto||'',id:t.artistId,tracks:0};artistMap[t.artistId].tracks++;if(t.artistPhoto)artistMap[t.artistId].photo=t.artistPhoto}});
  const artistResults=Object.values(artistMap).filter(a=>(a.name||'').toLowerCase().includes(query));
  document.getElementById('searchTitle').textContent='–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ¬´'+q+'¬ª';
  const as=document.getElementById('searchArtistsSection'),ag=document.getElementById('searchArtists');
  if(artistResults.length>0){as.style.display='';ag.innerHTML=artistResults.map(a=>'<div class="artist-card" onclick="viewArtist(\''+a.id+'\')"><div class="artist-img">'+(a.photo?'<img src="'+a.photo+'" alt="" loading="lazy">':'<span class="material-symbols-rounded" style="font-size:40px;color:var(--md-outline)">person</span>')+'</div><div class="card-title" style="font-size:13px">'+esc(a.name)+'</div><div class="card-sub">'+a.tracks+' —Ç—Ä–µ–∫–æ–≤</div></div>').join('')}else as.style.display='none';
  document.getElementById('searchResults').innerHTML=trackResults.length===0?'<div class="empty-state"><span class="material-symbols-rounded">search_off</span><h3>–ù–µ –Ω–∞–π–¥–µ–Ω–æ</h3></div>':trackResults.map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('');
}

/* ===== PLAYER ===== */
function showPlayer(){if(!playerVisible){playerVisible=true;document.getElementById('playerBar').classList.add('visible')}}

function playTrackById(id){
  const track=allTracks[id];if(!track||!track.audioData){showSnackbar('–ê—É–¥–∏–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');return}
  if(currentTrackId===id){togglePlay();return}
  currentTrackId=id;
  const ap=document.querySelector('.page.active'),items=ap?ap.querySelectorAll('.track-item'):[];
  playlist=[];items.forEach(it=>{const tid=it.dataset.id;if(tid&&allTracks[tid])playlist.push(tid)});
  playlistIndex=playlist.indexOf(id);if(playlistIndex===-1){playlist=[id];playlistIndex=0}
  loadAndPlay(track);
  const now=Date.now();
  if(!playCountCooldowns[id]||now-playCountCooldowns[id]>60000){playCountCooldowns[id]=now;db.ref('tracks/'+id+'/plays').transaction(p=>(p||0)+1)}
  if(currentUser)db.ref('history/'+currentUser.uid).push({trackId:id,time:Date.now()});
}

function loadAndPlay(track){
  showPlayer();
  document.getElementById('playerSong').textContent=track.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
  document.getElementById('playerArtist').textContent=track.artistName||'–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
  document.getElementById('playerExplicit').style.display=track.explicit?'inline-flex':'none';
  document.getElementById('playerThumb').innerHTML=track.cover?'<img src="'+track.cover+'" alt="">':'<span class="material-symbols-rounded">music_note</span>';
  document.getElementById('fsCover').innerHTML=track.cover?'<img src="'+track.cover+'" alt="">':'<span class="material-symbols-rounded">music_note</span>';
  document.getElementById('fsTitle').innerHTML=esc(track.title||'')+(track.explicit?' <span class="explicit-badge">!</span>':'');
  document.getElementById('fsArtist').textContent=track.artistName||'–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
  updateFsLike();renderQueue();
  if(audio.src&&!audio.paused){
    const origVol=audio.volume;
    const fadeOut=setInterval(()=>{if(audio.volume>0.05){audio.volume=Math.max(0,audio.volume-0.1)}else{clearInterval(fadeOut);audio.volume=origVol;doLoad(track)}},30);
  }else doLoad(track);
  document.querySelectorAll('.track-item').forEach(el=>{el.classList.toggle('playing',el.dataset.id===currentTrackId);const n=el.querySelector('.track-num');if(el.dataset.id===currentTrackId&&n)n.innerHTML='<span class="material-symbols-rounded filled" style="color:var(--md-primary);font-size:18px">equalizer</span>'});
  if('mediaSession' in navigator){navigator.mediaSession.metadata=new MediaMetadata({title:track.title||'',artist:track.artistName||'',artwork:track.cover?[{src:track.cover}]:[]});navigator.mediaSession.setActionHandler('play',()=>togglePlay());navigator.mediaSession.setActionHandler('pause',()=>togglePlay());navigator.mediaSession.setActionHandler('previoustrack',()=>prevTrack());navigator.mediaSession.setActionHandler('nexttrack',()=>nextTrack())}
}
function doLoad(track){audio.src=track.audioData;audio.play().then(()=>{isPlaying=true;updatePlayButton();document.getElementById('fsCover').classList.add('playing')}).catch(err=>{showSnackbar('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è')})}

function togglePlay(){if(!audio.src)return;if(isPlaying){audio.pause();document.getElementById('fsCover').classList.remove('playing')}else{audio.play();document.getElementById('fsCover').classList.add('playing')}isPlaying=!isPlaying;updatePlayButton()}
function updatePlayButton(){const ic=isPlaying?'pause':'play_arrow';document.getElementById('playIcon').textContent=ic;document.getElementById('fsPlayIcon').textContent=ic;document.getElementById('waveCircle').classList.toggle('playing-anim',isPlaying)}
function prevTrack(){if(!playlist.length)return;if(audio.currentTime>3){audio.currentTime=0;return}playlistIndex=(playlistIndex-1+playlist.length)%playlist.length;currentTrackId=playlist[playlistIndex];loadAndPlay(allTracks[currentTrackId])}
function nextTrack(){if(!playlist.length)return;if(isShuffle)playlistIndex=Math.floor(Math.random()*playlist.length);else playlistIndex=(playlistIndex+1)%playlist.length;currentTrackId=playlist[playlistIndex];loadAndPlay(allTracks[currentTrackId])}
function toggleShuffle(){isShuffle=!isShuffle;document.getElementById('shuffleBtn').classList.toggle('active',isShuffle);document.getElementById('fsShuffleBtn').classList.toggle('active',isShuffle);showSnackbar(isShuffle?'–ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –≤–∫–ª':'–ü–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –≤—ã–∫–ª')}
function toggleRepeat(){repeatMode=(repeatMode+1)%3;['repeatBtn','fsRepeatBtn'].forEach(id=>{const b=document.getElementById(id);b.classList.toggle('active',repeatMode>0);b.querySelector('.material-symbols-rounded').textContent=repeatMode===2?'repeat_one':'repeat'});showSnackbar(['–ü–æ–≤—Ç–æ—Ä –≤—ã–∫–ª','–ü–æ–≤—Ç–æ—Ä –ø–ª–µ–π–ª–∏—Å—Ç–∞','–ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞'][repeatMode])}

/* ===== AUDIO EVENTS ===== */
audio.addEventListener('timeupdate',()=>{
  if(!audio.duration)return;
  const pct=(audio.currentTime/audio.duration*100)+'%';
  document.getElementById('progressFill').style.width=pct;document.getElementById('fsProgressFill').style.width=pct;
  const ct=formatTime(audio.currentTime),tt=formatTime(audio.duration);
  document.getElementById('currentTime').textContent=ct;document.getElementById('totalTime').textContent=tt;
  document.getElementById('fsCurrentTime').textContent=ct;document.getElementById('fsTotalTime').textContent=tt;
});
audio.addEventListener('progress',()=>{if(audio.buffered.length>0&&audio.duration){document.getElementById('progressBuffered').style.width=(audio.buffered.end(audio.buffered.length-1)/audio.duration*100)+'%'}});
audio.addEventListener('ended',()=>{document.getElementById('fsCover').classList.remove('playing');if(repeatMode===2){audio.currentTime=0;audio.play();document.getElementById('fsCover').classList.add('playing')}else if(repeatMode===1||playlistIndex<playlist.length-1)nextTrack();else{isPlaying=false;updatePlayButton()}});

/* ===== PROGRESS & VOLUME DRAG ===== */
function initDrag(el,cb){
  let drag=false;
  const h=e=>{const r=el.getBoundingClientRect();cb(Math.max(0,Math.min(1,((e.clientX||e.touches?.[0]?.clientX||0)-r.left)/r.width)))};
  el.addEventListener('mousedown',e=>{drag=true;h(e)});
  el.addEventListener('touchstart',e=>{drag=true;h(e)},{passive:true});
  document.addEventListener('mousemove',e=>{if(drag)h(e)});
  document.addEventListener('touchmove',e=>{if(drag)h(e)},{passive:true});
  document.addEventListener('mouseup',()=>{drag=false});
  document.addEventListener('touchend',()=>{drag=false});
}
initDrag(document.getElementById('progressTrack'),p=>{if(audio.duration)audio.currentTime=p*audio.duration});
initDrag(document.getElementById('fsProgressTrack'),p=>{if(audio.duration)audio.currentTime=p*audio.duration});
let volume=0.8;audio.volume=volume;
initDrag(document.getElementById('volumeSlider'),v=>{volume=v;audio.volume=v;document.getElementById('volumeFill').style.width=(v*100)+'%';updateVolumeIcon()});
function toggleMute(){audio.muted=!audio.muted;updateVolumeIcon()}
function updateVolumeIcon(){document.getElementById('volumeBtn').querySelector('.material-symbols-rounded').textContent=audio.muted||volume===0?'volume_off':volume<.5?'volume_down':'volume_up'}
function formatTime(s){const m=Math.floor(s/60),sec=Math.floor(s%60);return m+':'+(sec<10?'0':'')+sec}

/* ===== FULLSCREEN PLAYER ===== */
function openFullscreenPlayer(){if(!currentTrackId)return;document.getElementById('fsPlayer').classList.add('open');updateFsLike();if(isPlaying)document.getElementById('fsCover').classList.add('playing')}
function closeFullscreenPlayer(){document.getElementById('fsPlayer').classList.remove('open')}
function updateFsLike(){const btn=document.getElementById('fsLikeBtn');if(!btn)return;const liked=currentTrackId&&favorites[currentTrackId];btn.classList.toggle('active',!!liked);btn.querySelector('.material-symbols-rounded').classList.toggle('filled',!!liked)}
function fsGoToArtist(){if(!currentTrackId||!allTracks[currentTrackId])return;closeFullscreenPlayer();viewArtist(allTracks[currentTrackId].artistId)}
function shareTrack(){if(currentTrackId)shareTrackById(currentTrackId)}
function toggleLyrics(){
  lyricsOpen=!lyricsOpen;const el=document.getElementById('fsLyrics');
  if(lyricsOpen){const t=allTracks[currentTrackId];el.style.display='block';el.textContent=t&&t.lyrics?t.lyrics:'–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω'}
  else el.style.display='none';
}

/* ===== QUEUE ===== */
function toggleQueue(){queueOpen=!queueOpen;document.getElementById('queuePanel').classList.toggle('open',queueOpen);if(queueOpen)renderQueue()}
function renderQueue(){
  const body=document.getElementById('queueBody');
  if(!playlist.length){body.innerHTML='<div class="empty-state" style="padding:20px"><span class="material-symbols-rounded">queue_music</span><h3>–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞</h3></div>';return}
  body.innerHTML=playlist.map((tid,i)=>{const t=allTracks[tid];if(!t)return'';
    return'<div class="queue-track '+(tid===currentTrackId?'active':'')+'" onclick="playFromQueue('+i+')"><div class="queue-track-thumb">'+(t.cover?'<img src="'+t.cover+'" alt="">':'<span class="material-symbols-rounded" style="font-size:20px;color:var(--md-outline)">music_note</span>')+'</div><div class="queue-track-info"><div class="queue-track-name">'+esc(t.title||'')+'</div><div class="queue-track-artist">'+esc(t.artistName||'')+'</div></div><button class="btn-icon" onclick="event.stopPropagation();removeFromQueue('+i+')" style="width:32px;height:32px"><span class="material-symbols-rounded" style="font-size:18px">close</span></button></div>'
  }).join('');
}
function playFromQueue(i){playlistIndex=i;currentTrackId=playlist[i];loadAndPlay(allTracks[currentTrackId])}
function removeFromQueue(i){if(i===playlistIndex)return;playlist.splice(i,1);if(i<playlistIndex)playlistIndex--;renderQueue();showSnackbar('–£–¥–∞–ª—ë–Ω –∏–∑ –æ—á–µ—Ä–µ–¥–∏')}
function clearQueue(){if(!playlist.length)return;const cur=currentTrackId;playlist=[cur];playlistIndex=0;renderQueue();showSnackbar('–û—á–µ—Ä–µ–¥—å –æ—á–∏—â–µ–Ω–∞')}

/* ===== FAVORITES ===== */
function toggleFavorite(tid){
  if(!currentUser){showSnackbar('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ª–∞–π–∫–æ–≤');return}if(!tid)return;
  if(favorites[tid]){db.ref('favorites/'+currentUser.uid+'/'+tid).remove();db.ref('tracks/'+tid+'/likes').transaction(l=>Math.max(0,(l||1)-1));showSnackbar('–£–¥–∞–ª–µ–Ω–æ –∏–∑ –ª—é–±–∏–º–æ–≥–æ')}
  else{db.ref('favorites/'+currentUser.uid+'/'+tid).set(true);db.ref('tracks/'+tid+'/likes').transaction(l=>(l||0)+1);showSnackbar('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ª—é–±–∏–º–æ–µ')}
}
function renderFavorites(){
  const fids=Object.keys(favorites),em=document.getElementById('favEmpty'),list=document.getElementById('favTracks'),btn=document.getElementById('playAllFavBtn'),sbtn=document.getElementById('shuffleFavBtn');
  if(fids.length===0){em.style.display='';list.innerHTML='';btn.style.display='none';sbtn.style.display='none';return}
  em.style.display='none';btn.style.display='';sbtn.style.display='';
  list.innerHTML=fids.map(id=>[id,allTracks[id]]).filter(([id,t])=>t).map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('');
  document.getElementById('profileLikes').textContent=fids.length;
}
function playAllFavorites(){const f=Object.keys(favorites).filter(id=>allTracks[id]);if(!f.length)return;playlist=f;playlistIndex=0;currentTrackId=playlist[0];loadAndPlay(allTracks[currentTrackId])}
function shuffleFavorites(){const f=Object.keys(favorites).filter(id=>allTracks[id]);if(!f.length)return;shuffleArr(f);playlist=f;playlistIndex=0;currentTrackId=playlist[0];loadAndPlay(allTracks[currentTrackId]);showSnackbar('–ü–µ—Ä–µ–º–µ—à–∞–Ω–æ')}

/* ===== SUBSCRIPTIONS ===== */
function toggleSubscription(aid){
  if(!currentUser){showSnackbar('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏');return}
  if(aid===currentUser.uid){showSnackbar('–ù–µ–ª—å–∑—è –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–µ–±—è');return}
  if(subscriptions[aid]){db.ref('subscriptions/'+currentUser.uid+'/'+aid).remove();db.ref('subscribers/'+aid+'/'+currentUser.uid).remove();showSnackbar('–û—Ç–ø–∏—Å–∞–ª–∏—Å—å')}
  else{db.ref('subscriptions/'+currentUser.uid+'/'+aid).set(true);db.ref('subscribers/'+aid+'/'+currentUser.uid).set(true);showSnackbar('–ü–æ–¥–ø–∏—Å–∞–ª–∏—Å—å')}
}
function renderSubscriptions(){
  const sids=Object.keys(subscriptions),em=document.getElementById('subsEmpty'),grid=document.getElementById('subsGrid');
  if(sids.length===0){em.style.display='';grid.innerHTML='';document.getElementById('subsFeedTitle').style.display='none';document.getElementById('subsFeedTracks').innerHTML='';return}
  em.style.display='none';
  Promise.all(sids.map(id=>db.ref('users/'+id).once('value'))).then(snaps=>{
    grid.innerHTML=snaps.map((s,i)=>{const u=s.val()||{};return'<div class="artist-card" onclick="viewArtist(\''+sids[i]+'\')"><div class="artist-img">'+(u.photo?'<img src="'+u.photo+'" alt="">':'<span class="material-symbols-rounded" style="font-size:40px;color:var(--md-outline)">person</span>')+'</div><div class="card-title" style="font-size:13px">'+esc(u.displayName||'–ê—Ä—Ç–∏—Å—Ç')+'</div></div>'}).join('');
  });
  // Feed
  const feedTracks=Object.entries(allTracks).filter(([id,t])=>sids.includes(t.artistId)).sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0)).slice(0,20);
  if(feedTracks.length>0){document.getElementById('subsFeedTitle').style.display='';document.getElementById('subsFeedTracks').innerHTML=feedTracks.map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('')}
}

/* ===== PLAYLISTS ===== */
function createPlaylist(){if(!currentUser){showSnackbar('–í–æ–π–¥–∏—Ç–µ');return}document.getElementById('playlistModal').classList.add('open');document.getElementById('playlistNameInput').value='';document.getElementById('playlistDescInput').value=''}
function savePlaylist(){const n=document.getElementById('playlistNameInput').value.trim();if(!n){showSnackbar('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return}if(!currentUser)return;db.ref('playlists/'+currentUser.uid).push({name:n,description:document.getElementById('playlistDescInput').value.trim(),tracks:{},created:Date.now()});closeModal('playlistModal');showSnackbar('–ü–ª–µ–π–ª–∏—Å—Ç —Å–æ–∑–¥–∞–Ω')}
function renderPlaylists(){
  const entries=Object.entries(userPlaylists),c=document.getElementById('playlistsContent'),g=document.getElementById('playlistsGrid');
  if(entries.length===0){c.style.display='';g.innerHTML='';return}
  c.style.display='none';
  g.innerHTML=entries.map(([id,pl])=>{const tc=pl.tracks?Object.keys(pl.tracks).length:0;return'<div class="md-card" onclick="viewPlaylist(\''+id+'\')"><div class="card-img"><span class="material-symbols-rounded">queue_music</span></div><div class="card-body"><div class="card-title">'+esc(pl.name)+'</div><div class="card-sub">'+tc+' —Ç—Ä–µ–∫–æ–≤</div></div></div>'}).join('');
}
function viewPlaylist(plId){
  const pl=userPlaylists[plId];if(!pl)return;
  navigate('playlist-view');
  const tids=pl.tracks?Object.keys(pl.tracks):[];
  const tracks=tids.map(id=>[id,allTracks[id]]).filter(([id,t])=>t);
  document.getElementById('playlistViewHeader').innerHTML='<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap"><div style="width:120px;height:120px;border-radius:var(--md-shape-lg);background:var(--md-primary-container);display:flex;align-items:center;justify-content:center"><span class="material-symbols-rounded" style="font-size:48px;color:var(--md-primary)">queue_music</span></div><div><div class="section-title" style="margin:0">'+esc(pl.name)+'</div>'+(pl.description?'<div class="section-sub" style="margin:4px 0 0">'+esc(pl.description)+'</div>':'')+'<div style="font:400 13px/18px \'Inter\',sans-serif;color:var(--md-on-surface-variant);margin-top:4px">'+tracks.length+' —Ç—Ä–µ–∫–æ–≤</div><div style="display:flex;gap:8px;margin-top:12px">'+(tracks.length?'<button class="btn-primary" onclick="playPlaylist(\''+plId+'\')"><span class="material-symbols-rounded">play_arrow</span> –°–ª—É—à–∞—Ç—å</button><button class="btn-tonal" onclick="shufflePlaylist(\''+plId+'\')"><span class="material-symbols-rounded">shuffle</span> –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>':'')+'<button class="btn-outlined" onclick="deletePlaylist(\''+plId+'\')"><span class="material-symbols-rounded">delete</span> –£–¥–∞–ª–∏—Ç—å</button></div></div></div>';
  document.getElementById('playlistViewTracks').innerHTML=tracks.length===0?'<div class="empty-state"><span class="material-symbols-rounded">queue_music</span><h3>–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç</h3></div>':tracks.map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('');
}
function playPlaylist(plId){const pl=userPlaylists[plId];if(!pl)return;const tids=Object.keys(pl.tracks||{}).filter(id=>allTracks[id]);if(!tids.length){showSnackbar('–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç');return}playlist=tids;playlistIndex=0;currentTrackId=playlist[0];loadAndPlay(allTracks[currentTrackId])}
function shufflePlaylist(plId){const pl=userPlaylists[plId];if(!pl)return;const tids=Object.keys(pl.tracks||{}).filter(id=>allTracks[id]);if(!tids.length)return;shuffleArr(tids);playlist=tids;playlistIndex=0;currentTrackId=playlist[0];loadAndPlay(allTracks[currentTrackId]);showSnackbar('–ü–µ—Ä–µ–º–µ—à–∞–Ω–æ')}
function deletePlaylist(plId){if(!currentUser)return;db.ref('playlists/'+currentUser.uid+'/'+plId).remove();navigate('playlists');showSnackbar('–ü–ª–µ–π–ª–∏—Å—Ç —É–¥–∞–ª—ë–Ω')}

/* ===== VIEW ARTIST ===== */
function viewArtist(aid){
  navigate('artist');currentArtistId=aid;
  const h=document.getElementById('artistHeader'),tl=document.getElementById('artistTracks');
  h.innerHTML='<div class="loading-spinner"></div>';tl.innerHTML='';
  document.getElementById('artistTabs').style.display='none';
  db.ref('users/'+aid).once('value').then(s=>{
    const u=s.val()||{};const isSub=subscriptions[aid];
    db.ref('subscribers/'+aid).once('value').then(ss=>{
      const sc=Object.keys(ss.val()||{}).length;
      currentArtistTracks=Object.entries(allTracks).filter(([id,t])=>t.artistId===aid).sort((a,b)=>(b[1].timestamp||0)-(a[1].timestamp||0));
      const totalPlays=currentArtistTracks.reduce((s,[id,t])=>s+(t.plays||0),0);
      h.innerHTML='<div class="artist-page-avatar">'+(u.photo?'<img src="'+u.photo+'" alt="">':'<span class="material-symbols-rounded" style="font-size:64px;color:var(--md-primary)">person</span>')+'</div><div style="flex:1"><div style="font:800 28px/36px \'Inter\',sans-serif;color:var(--md-on-surface)">'+esc(u.displayName||'–ê—Ä—Ç–∏—Å—Ç')+'</div>'+(u.username?'<div style="font:400 14px/20px \'Inter\',sans-serif;color:var(--md-on-surface-variant);margin:4px 0">@'+esc(u.username)+'</div>':'')+(u.bio?'<div style="font:400 14px/20px \'Inter\',sans-serif;color:var(--md-on-surface-variant);margin:4px 0">'+esc(u.bio)+'</div>':'')+'<div style="font:400 14px/20px \'Inter\',sans-serif;color:var(--md-on-surface-variant);display:flex;gap:16px;flex-wrap:wrap"><span>'+currentArtistTracks.length+' —Ç—Ä–µ–∫–æ–≤</span><span>'+sc+' –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</span><span>'+formatPlays(totalPlays)+' –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π</span></div><div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">'+(currentArtistTracks.length?'<button class="btn-primary" onclick="playArtistAll()"><span class="material-symbols-rounded">play_arrow</span> –°–ª—É—à–∞—Ç—å</button>':'')+(currentUser&&currentUser.uid!==aid?'<button class="'+(isSub?'btn-outlined':'btn-tonal')+'" onclick="toggleSubscription(\''+aid+'\');setTimeout(function(){viewArtist(\''+aid+'\')},500)"><span class="material-symbols-rounded">'+(isSub?'person_remove':'person_add')+'</span>'+(isSub?' –û—Ç–ø–∏—Å–∞—Ç—å—Å—è':' –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è')+'</button>':'')+'</div></div>';
      document.getElementById('artistTabs').style.display='flex';
      tl.innerHTML=currentArtistTracks.length===0?'<div class="empty-state"><span class="material-symbols-rounded">library_music</span><h3>–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤</h3></div>':currentArtistTracks.map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('');
    });
  });
}
function switchArtistTab(tab,el){
  document.querySelectorAll('#artistTabs .tab-item').forEach(t=>t.classList.remove('active'));el.classList.add('active');
  const tl=document.getElementById('artistTracks');
  if(tab==='tracks')tl.innerHTML=currentArtistTracks.map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('');
  else if(tab==='popular'){const sorted=[...currentArtistTracks].sort((a,b)=>(b[1].plays||0)-(a[1].plays||0));tl.innerHTML=sorted.map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('')}
}
function playArtistAll(){if(!currentArtistTracks.length)return;playlist=currentArtistTracks.map(([id])=>id);playlistIndex=0;currentTrackId=playlist[0];loadAndPlay(allTracks[currentTrackId])}

/* ===== WAVE ===== */
function startWave(){
  const entries=Object.entries(allTracks);if(!entries.length){showSnackbar('–ù–µ—Ç —Ç—Ä–µ–∫–æ–≤');return}
  const fids=Object.keys(favorites),fe=entries.filter(([id])=>fids.includes(id)),nfe=entries.filter(([id])=>!fids.includes(id));
  shuffleArr(fe);shuffleArr(nfe);let wt=fe.length?[...fe,...nfe]:[...entries];if(!fe.length)shuffleArr(wt);
  document.getElementById('waveTracks').innerHTML=wt.map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('');
  playlist=wt.map(([id])=>id);playlistIndex=0;currentTrackId=playlist[0];loadAndPlay(allTracks[currentTrackId]);
  isShuffle=true;document.getElementById('shuffleBtn').classList.add('active');document.getElementById('fsShuffleBtn').classList.add('active');
  document.getElementById('waveBtn').innerHTML='<span class="material-symbols-rounded">refresh</span> –û–±–Ω–æ–≤–∏—Ç—å –≤–æ–ª–Ω—É';showSnackbar('–í–æ–ª–Ω–∞ –∑–∞–ø—É—â–µ–Ω–∞!');
}
function shuffleArr(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}

/* ===== UPLOAD ===== */
function handleAudioDrop(e){e.preventDefault();e.currentTarget.classList.remove('dragover');if(e.dataTransfer.files[0])processAudioFile(e.dataTransfer.files[0])}
function handleAudioSelect(e){if(e.target.files[0])processAudioFile(e.target.files[0])}
async function processAudioFile(f){
  if(!f.type.startsWith('audio/')){showSnackbar('–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª');return}
  if(f.size>15*1024*1024){showSnackbar('–§–∞–π–ª –º–∞–∫—Å. 15 –ú–ë');return}
  selectedAudioFile=f;
  document.getElementById('selectedFileInfo').style.display='block';
  document.getElementById('selectedFileName').textContent=f.name+' ('+(f.size/1024/1024).toFixed(1)+' –ú–ë)';
  if(!document.getElementById('uploadTitle').value)document.getElementById('uploadTitle').value=f.name.replace(/\.[^/.]+$/,'');
  const cover=await extractEmbeddedCover(f);
  if(cover&&!selectedCoverDataURL&&!document.getElementById('uploadCover').value){selectedCoverDataURL=cover;document.getElementById('coverUploadZone').innerHTML='<img src="'+cover+'" alt="">';showSnackbar('–û–±–ª–æ–∂–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞')}
  const r=new FileReader();r.onload=e=>{selectedAudioDataURL=e.target.result};r.readAsDataURL(f);
}
function clearSelectedFile(){selectedAudioFile=null;selectedAudioDataURL=null;document.getElementById('selectedFileInfo').style.display='none';document.getElementById('audioFileInput').value=''}

async function publishTrack(){
  if(!currentUser){showSnackbar('–í–æ–π–¥–∏—Ç–µ');return}
  const title=document.getElementById('uploadTitle').value.trim();
  let genre=document.getElementById('uploadGenre').value;
  if(genre==='custom')genre=document.getElementById('uploadCustomGenre').value.trim().toLowerCase()||'other';
  let cover=document.getElementById('uploadCover').value.trim();
  if(selectedCoverDataURL)cover=selectedCoverDataURL;
  const lyrics=document.getElementById('uploadLyrics').value.trim();
  if(!title){showSnackbar('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return}
  if(!selectedAudioDataURL){showSnackbar('–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª');return}
  const pe=document.getElementById('uploadProgress'),pb=document.getElementById('uploadProgressBar'),st=document.getElementById('uploadStatusText'),btn=document.getElementById('publishBtn');
  pe.style.display='block';btn.disabled=true;
  st.textContent='–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É–¥–∏–æ...';pb.style.width='10%';
  const duration=await new Promise(res=>{const ta=new Audio(selectedAudioDataURL);ta.addEventListener('loadedmetadata',()=>{if(ta.duration<15){showSnackbar('–¢—Ä–µ–∫ –º–∏–Ω. 15 —Å–µ–∫');pe.style.display='none';btn.disabled=false;res(false);return}res(ta.duration)});ta.addEventListener('error',()=>{showSnackbar('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∞—É–¥–∏–æ');pe.style.display='none';btn.disabled=false;res(false)})});
  if(duration===false)return;
  st.textContent='–ò–ò-–º–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞...';pb.style.width='40%';
  await new Promise(r=>setTimeout(r,500));
  const isExp=checkExplicit(title)||checkExplicit(lyrics);pb.style.width='60%';
  st.textContent='–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';pb.style.width='75%';
  await new Promise(r=>setTimeout(r,300));
  const szMB=(selectedAudioDataURL.length*0.75)/(1024*1024);
  if(szMB>10){showSnackbar('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –ë–î');pe.style.display='none';btn.disabled=false;return}
  if(cover&&cover.startsWith('data:')&&(cover.length*0.75)/(1024*1024)>2){showSnackbar('–û–±–ª–æ–∂–∫–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è');pe.style.display='none';btn.disabled=false;return}
  st.textContent='–ü—É–±–ª–∏–∫–∞—Ü–∏—è...';pb.style.width='90%';
  try{
    await db.ref('tracks').push({title,genre:genre||'other',cover,lyrics,artistId:currentUser.uid,artistName:currentUser.displayName||'–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω',artistPhoto:currentUser.photo||'',audioData:selectedAudioDataURL,duration:Math.round(duration),explicit:isExp,likes:0,plays:0,timestamp:Date.now(),moderated:true});
    pb.style.width='100%';st.textContent='–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!';
    setTimeout(()=>{pe.style.display='none';btn.disabled=false;pb.style.width='0%';document.getElementById('uploadTitle').value='';document.getElementById('uploadGenre').value='';document.getElementById('uploadCover').value='';document.getElementById('uploadLyrics').value='';document.getElementById('uploadCustomGenre').value='';document.getElementById('uploadCustomGenre').style.display='none';selectedCoverDataURL=null;document.getElementById('coverUploadZone').innerHTML='<span class="material-symbols-rounded">image</span><span style="font:400 11px/14px \'Inter\',sans-serif;color:var(--md-on-surface-variant)">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span>';clearSelectedFile();showSnackbar(isExp?'–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω (–Ω–µ–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞)':'–¢—Ä–µ–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!')},800);
  }catch(err){showSnackbar('–û—à–∏–±–∫–∞: '+err.message);pe.style.display='none';btn.disabled=false}
}

function deleteTrack(id){deleteTrackId=id;document.getElementById('deleteModal').classList.add('open')}
function confirmDeleteTrack(){
  if(!deleteTrackId||!currentUser)return;const t=allTracks[deleteTrackId];
  if(!t||t.artistId!==currentUser.uid){showSnackbar('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞');closeModal('deleteModal');return}
  db.ref('tracks/'+deleteTrackId).remove();
  if(currentTrackId===deleteTrackId){audio.pause();audio.src='';playerVisible=false;document.getElementById('playerBar').classList.remove('visible');currentTrackId=null;isPlaying=false;updatePlayButton()}
  closeModal('deleteModal');showSnackbar('–¢—Ä–µ–∫ —É–¥–∞–ª—ë–Ω');deleteTrackId=null;
}

/* ===== PROFILE TABS ===== */
function switchProfileTab(tab,el){
  document.querySelectorAll('#page-profile .tab-item').forEach(t=>t.classList.remove('active'));el.classList.add('active');
  const c=document.getElementById('profileTabContent');
  if(tab==='tracks'){c.innerHTML='<div class="track-list" id="profileTrackList"><div class="loading-spinner"></div></div>';loadMyTracks()}
  else if(tab==='liked'){const fids=Object.keys(favorites),tracks=fids.map(id=>[id,allTracks[id]]).filter(([id,t])=>t);c.innerHTML=tracks.length===0?'<div class="empty-state"><span class="material-symbols-rounded">favorite</span><h3>–ù–µ—Ç –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è</h3></div>':'<div class="track-list">'+tracks.map(([id,t],i)=>renderTrackItem(id,t,i+1)).join('')+'</div>'}
  else if(tab==='stats'){
    const myT=Object.entries(allTracks).filter(([id,t])=>t.artistId===currentUser?.uid);
    const totalP=myT.reduce((s,[id,t])=>s+(t.plays||0),0),totalL=myT.reduce((s,[id,t])=>s+(t.likes||0),0);
    const topTrack=myT.sort((a,b)=>(b[1].plays||0)-(a[1].plays||0))[0];
    c.innerHTML='<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px">'+
      '<div class="stat-card"><div class="stat-value">'+myT.length+'</div><div class="stat-label">–í—Å–µ–≥–æ —Ç—Ä–µ–∫–æ–≤</div></div>'+
      '<div class="stat-card"><div class="stat-value">'+formatPlays(totalP)+'</div><div class="stat-label">–û–±—â–µ–µ —á–∏—Å–ª–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π</div></div>'+
      '<div class="stat-card"><div class="stat-value">'+totalL+'</div><div class="stat-label">–û–±—â–µ–µ —á–∏—Å–ª–æ –ª–∞–π–∫–æ–≤</div></div>'+
      '<div class="stat-card"><div class="stat-value">'+Object.keys(favorites).length+'</div><div class="stat-label">–¢—Ä–µ–∫–æ–≤ –≤ –ª—é–±–∏–º–æ–º</div></div>'+
      '<div class="stat-card"><div class="stat-value">'+Object.keys(subscriptions).length+'</div><div class="stat-label">–ü–æ–¥–ø–∏—Å–æ–∫</div></div>'+
      '<div class="stat-card"><div class="stat-value">'+Object.keys(userPlaylists).length+'</div><div class="stat-label">–ü–ª–µ–π–ª–∏—Å—Ç–æ–≤</div></div>'+
      '</div>'+(topTrack?'<div class="section-title" style="margin-top:24px">üèÜ –°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π —Ç—Ä–µ–∫</div><div class="track-list">'+renderTrackItem(topTrack[0],topTrack[1],1)+'</div>':'');
  }
}

/* ===== NAVIGATION ===== */
function navigate(page){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const t=document.getElementById('page-'+page);if(t)t.classList.add('active');
  document.querySelectorAll('.sidebar .nav-item').forEach(n=>n.classList.toggle('active',n.dataset.page===page));
  document.querySelectorAll('.bottom-nav .nav-tab').forEach(n=>n.classList.toggle('active',n.dataset.page===page));
  if(window.innerWidth<=1024){document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('open')}
  window.scrollTo({top:0,behavior:'smooth'});
  if(['favorites','subscriptions','playlists'].includes(page)){if(!currentUser)showSnackbar('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞');else{renderFavorites();renderSubscriptions();renderPlaylists()}}
  if(page==='explore')renderExplore();
  if(page==='profile'&&currentUser)loadMyTracks();
  if(page==='history')renderHistory();
  if(page==='charts')renderCharts();
  if(page==='new-releases')renderNewReleases();
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('open')}

/* ===== THEME ===== */
function toggleTheme(){
  const d=document.body.hasAttribute('data-theme');
  if(d){document.body.removeAttribute('data-theme');document.getElementById('themeIcon').textContent='dark_mode';localStorage.setItem('theme','light')}
  else{document.body.setAttribute('data-theme','dark');document.getElementById('themeIcon').textContent='light_mode';localStorage.setItem('theme','dark')}
}
if(localStorage.getItem('theme')==='dark'||(!localStorage.getItem('theme')&&window.matchMedia('(prefers-color-scheme:dark)').matches)){document.body.setAttribute('data-theme','dark');document.getElementById('themeIcon').textContent='light_mode'}

/* ===== UTILS ===== */
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function showSnackbar(msg){const s=document.getElementById('snackbar');s.textContent=msg;s.classList.remove('show');void s.offsetWidth;s.classList.add('show');clearTimeout(s._t);s._t=setTimeout(()=>s.classList.remove('show'),3000)}
function closeModal(id){document.getElementById(id).classList.remove('open')}

/* ===== EVENT LISTENERS ===== */
window.addEventListener('scroll',()=>{document.getElementById('topBar').classList.toggle('scrolled',window.scrollY>10)});
function checkResponsive(){const b=document.getElementById('sidebarCloseBtn');if(window.innerWidth<=1024)b.style.display='';else{b.style.display='none';document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('open')}}
window.addEventListener('resize',checkResponsive);checkResponsive();
document.addEventListener('click',e=>{document.querySelectorAll('.modal-overlay').forEach(m=>{if(e.target===m)m.classList.remove('open')})});
document.addEventListener('keydown',e=>{
  if(['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName))return;
  if(e.code==='Space'){e.preventDefault();togglePlay()}
  if(e.code==='ArrowRight'&&e.ctrlKey)nextTrack();if(e.code==='ArrowLeft'&&e.ctrlKey)prevTrack();
  if(e.key==='Escape'){closeFullscreenPlayer();if(queueOpen)toggleQueue();document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('open'));document.querySelectorAll('.track-context-menu').forEach(m=>m.remove())}
});
document.addEventListener('keydown',e=>{if(e.key!=='Enter')return;if(e.target.id==='loginIdentity'||e.target.id==='loginPassword')doLogin();if(e.target.id==='regPassword2')doRegister()});

/* ===== INIT ===== */
restoreSession();updateUserMenu();
</script>
</body>
</html>
